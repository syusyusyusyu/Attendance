# 運用保守ガイド
## 1. 目的と対象
- 本番運用の安定稼働、品質維持、迅速復旧を目的とします。
- 対象は管理者/運用担当/開発担当です。
- 学期切替や大規模イベント時の運用負荷を平準化します。

## 2. 体制と権限
- 管理者は承認/権限/設定の最終責任を持ちます。
- 運用担当は監視/障害対応/問い合わせ一次対応を担当します。
- 重要操作は二名確認、共有アカウントは使いません。

## 3. 日次/週次/月次チェック
- 日次: 500率、ログイン失敗率、QRスキャン失敗率、通知失敗数を確認します。
- 週次: 監査ログ/不正検知の傾向、端末承認の棚卸しを確認します。
- 月次: バックアップ復元テスト、依存ライブラリ更新計画をレビューします。

## 4. 監視とアラート
- 監視対象は応答時間、エラーレート、DB接続数、キュー滞留、ストレージ残量です。
- しきい値と通知先は運用台帳で管理し、変更時に履歴を残します。
- 監視アラートは優先度(S0-S3)で分類します。

## 5. 障害対応フロー
- 影響範囲を特定し、一次対応として機能停止や回避策を実施します。
- 重要障害は学内連絡とステータス通知を最優先に行います。
- 復旧後に原因/再発防止/恒久対策をまとめ、次回運用に反映します。

## 6. リリース手順
- 事前: マイグレーションの後方互換性と復旧手順を確認します。
- デプロイ: RenderのBuild/Deploy後に`db:migrate`の結果を確認します。
- 事後: ログイン/QR発行/QRスキャン/レポート出力のスモークを実施します。

## 7. バックアップ/復旧
- RenderのPostgreSQL自動バックアップを有効化し、復元手順を共有します。
- 手動バックアップは`pg_dump`/`psql`で取得し、復旧リハーサルを行います。
- 復旧時は`DATABASE_URL`と`RAILS_MASTER_KEY`の整合を確認します。

## 8. データ保持/クリーンアップ
- 監査ログ/スキャンログの保持期間を運用で定義します。
- QRセッションや通知の不要データは運用保守で棚卸しします。
- 削除操作は管理者のみが行い、履歴を残します。

## 9. 秘密情報/キー管理
- `QR_TOKEN_SECRET`、通知トークン、VAPID鍵は定期的にローテーションします。
- キー更新時は再ログイン/再購読が必要になるため、事前告知します。
- 秘密情報は環境変数で管理し、リポジトリに保存しません。

## 10. セキュリティ/アクセス管理
- 管理者アカウントは最小人数に限定し、権限を最小化します。
- 退職/卒業/異動時はアカウント停止と権限見直しを即時実施します。
- 監査ログの改ざん防止を優先し、理由必須ルールを維持します。

## 11. テスト/検証
- リリース前に`bin/rails test`を実施し、主要画面の手動スモークを行います。
- モバイル/PCのレスポンシブ確認を毎リリースで実施します。
- 重要変更はステージングで事前確認します。

## 12. 参照
- 教員運用: `OPERATION_GUIDE.md`
- 仕様書: `仕様書.md`
- デモ: `DEMO.md`
