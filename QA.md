# 展示用 QA

このドキュメントは、学内作品会で想定される「ありとあらゆる」質問に速やかに答えられるよう作成した Q&A 集です。エンジニア（上級〜凄腕）、教員（研究・実務の先生方）、在学生（興味・操作・拡張の相談）それぞれに向けた技術的・教育的・実務的な回答を含みます。

---

## 1. プロジェクト概要
- **目的**: 出席管理アプリケーション。QR スキャンによる出席打刻、クラス管理、履歴参照、PWA ベースの簡易モバイル対応など。
- **主要技術**: Ruby on Rails（サーバーサイド）、Tailwind CSS（スタイリング）、Importmap + ESBuild などの JS バンドリング（環境に依存）
- **主要機能**: ユーザー認証、クラス/履修管理、出席トークン生成、QR コード生成・スキャン、管理画面、PWA マニフェスト（オプション）

---

## 2. 動作／ローカル起動方法（開発者向け）
- 前提: Ruby と Bundler、Node.js（必要に応じて）、DB（SQLite／Postgres）
- 開発サーバー起動:

```bash
bundle install
bin/rails db:setup
bin/rails server
```

- アセットプリコンパイル（本番相当の確認）:

```bash
bin/rails assets:precompile
```

---

## 3. アーキテクチャ概要（技術者向け）
- **MVC レイヤ**: `app/models`, `app/controllers`, `app/views` を標準的に採用。
- **主要モデル**:
  - `User` — 教員・学生を区別する属性を持つ。
  - `SchoolClass` — 授業単位。
  - `Enrollment` — 生徒の履修情報。
  - `AttendanceRecord` — 出席情報（トークン、時刻、手段）
- **認証**: セッションベース（Devise 未使用の場合もあり）→ `SessionsController` を参照。
- **QR / Token**: `AttendanceToken` サービスでトークン発行。QR エンコードはサーバー側で生成しているか、フロントで生成する実装が混在しています。

---

## 4. セキュリティ・プライバシー（先生・管理者向け）
- **個人情報**: 学生名・学籍番号などは最小限にするかハッシュ化保存を推奨。
- **認可**: 教員専用ページは `current_user` の役割チェックで保護。
- **トークンの安全性**: 出席用トークンは短時間有効にし、ログに平文で残さない運用を推奨。
- **CSRF / CSP**: Rails の `csrf_meta_tags` と `csp_meta_tag` を使用済み。

---

## 5. パフォーマンスとスケーラビリティ（凄腕エンジニア向け）
- **負荷点**: QR 生成・画像提供、JSON API の大量クライアントアクセス、DB の出席レコード挿入。
- **改善案**:
  - キャッシュ戦略（Redis ユーザセッション・頻出クエリのキャッシュ）
  - バッチ挿入やジョブキュー（ActiveJob + Sidekiq）で高負荷時間帯を平準化
  - インデックス最適化（`attendance_records` の `created_at`, `user_id`, `class_id`）

---

## 6. テスト・品質保証
- **テスト構成**: `test/` にモデルテスト・統合テストあり（Rails Minitest）。
- **推奨追加**: システムテスト（Capybara）で QR スキャンのフロー、API レート制限の単体テスト。

---

## 7. デプロイ／運用（教員・技術運用向け）
- **Heroku / Render / VPS** いずれでも可能。Postgres を推奨。
- **環境変数**: DB 接続、シークレットキー、QR 生成キー（必要なら）を `.env` / シークレット管理で設定。
- **監視**: ログ収集（Papertrail 等）とエラー監視（Sentry 等）導入を推奨。

---

## 8. UI／UX／アクセシビリティ（学生・先生向け）
- **モバイル対応**: PWA を意識した `apple-touch-icon` とマニフェスト対応（コメントで有効化候補あり）。
- **アクセシビリティ**: コントラスト、キーボード操作、スクリーンリーダーの`aria`属性対応を重点チェック。

---

## 9. よくある質問（FAQ）

### Q: 学生データを一括で登録したい
A: `db/seeds.rb` の形式に合わせて CSV → `Enrollment` を作成するスクリプトを用意できます。必要ならサンプルを生成します。

### Q: QR を偽造されたら？
A: トークンは短時間（例: 5分以内）有効に設定し、打刻時に IP やデバイス情報をログに取り監査可能にします。さらに課題があれば署名付きトークン（HMAC）を導入可能です。

### Q: オフラインで使えますか？
A: PWA のキャッシュを拡張すれば読み取りや表示の一部をオフラインで可能にできますが、正確な出席集計はサーバー同期が必要です。

### Q: 既存の学務システムと連携できますか？
A: REST API を追加してエクスポート/インポート（CSV / JSON / LDAP 等）で連携可能です。変換レイヤを実装すれば柔軟に対応できます。

### Q: 学生が退学したらデータは？
A: 保持ポリシーに従い「匿名化」または削除を行います。法令や学校規程に合わせて実装してください。

---

## 10. デモ用短いスクリプト（展示用トーク）
1. 「学生」アカウントでログインしてもらう。
2. クラスページに移動 → QR を表示。
3. 別端末で QR をスキャンして出席打刻の即時反映を見せる。
4. 管理者画面で日次レポートを表示してまとめ表示を見せる。

---

## 11. 典型的な専門家からの想定質問（短答）
- DB 正規化の程度: 第3正規形を想定（集計用に冗長テーブルを追加可）。
- トランザクション: 出席打刻は ACID を保証するトランザクション内で処理。
- スキーマ移行: Rails マイグレーションを使用。互換性を保つためダウンタイム最小化の手法を検討可能。

---

## 12. トラブルシュート（短いチェックリスト）
- アクセスできない: `bin/rails server` のログを確認。
- アセットが表示されない: `bin/rails assets:precompile` を実行、ブラウザのキャッシュクリア。
- DB マイグレーション不整合: `bin/rails db:migrate:status` を確認し、必要なら `rails db:setup` を実行（注意: データ消失の可能性あり）。

---

## 13. 今後の拡張アイデア（議論の種）
- SSO（学内認証連携）
- 分析ダッシュボード（出席率、欠席傾向の可視化）
- 自動通知（欠席時のメール送信、保護者通知）

---

## 14. 連絡先・コントリビューション
- 関連ファイル: `app/models`, `app/controllers`, `app/services` を参照してください。変更希望や追加機能は Pull Request または直接連絡で受け付けます。

---

必要に応じて、この `QA.md` をより技術的に深掘りしたバージョン（アーキテクチャ図、シーケンス図、ER 図、サンプル SQL、API スペック）に拡張します。どの層を増やしますか？

## 追加: QR本格導入 Q&A

### Q: カメラが使えない端末ではどうする？
A: QR文字列の手入力にフォールバックできます。

### Q: QR_TOKEN_SECRET を変えるとどうなる？
A: 既存のQRトークンはすべて無効になります。

### Q: 重複スキャンはどう扱われる？
A: 既に出席済みの場合は「すでに出席済み」として扱い、スキャンログには duplicate が記録されます。

### Q: 出席データを配布したい場合は？
A: 出席管理画面からCSVをダウンロードできます(Excel対応のBOM付き)。

### Q: カメラQRスキャン対応ブラウザは？
A: Chromium系(Chrome/Edge/Opera/Samsung Internet)を推奨。Safari/iOSは未対応の可能性が高いので手入力を利用。

### Q: CSVは期間指定できる？
A: `start_date`/`end_date` を指定して期間出力できる。1日だけなら同日指定。

### Q: CSVに追加された項目は？
A: クラス名、QRセッションID、IP、UserAgent、備考。

### Q: 遅刻や締切の判定はどう決める？
A: クラスごとの出席ポリシーで「遅刻判定(分)」「締切(分)」「開始前許可」を設定できます。

### Q: QRスキャンの監査ログは見られる？
A: 教員は `/scan-logs` でスキャン結果と出席判定、IP/端末情報を確認できます。

### Q: CSVインポートの形式は？
A: `日付/学生ID/出席状況` が必須で、出席状況は `出席/遅刻/欠席/公欠`。`未入力` はスキップされます。

### Q: クラスや名簿はどこで管理する？
A: 教員の「クラス管理」からクラス作成・名簿CSVインポート・履修追加/削除が可能です。

### Q: 休講や補講はどう設定する？
A: クラス詳細画面の「特別日程」で日付単位の休講/補講を登録できます。

### Q: 出席修正の理由は残る？
A: はい。修正時に理由入力が必須で、出席変更ログに記録されます。

### Q: 出席レポートは見られる？
A: `/reports` で期間を指定してクラス別・学生別の出席傾向を確認できます。

### Q: 通知機能はある？
A: `/notifications` で出席更新・休講・遅刻の通知を確認できます。

### Q: QRスキャンのセキュリティは？
A: 分間スキャン上限、許可IP/端末キーワードの制限を設定できます。

### Q: QRスキャン結果は教員画面に反映される？
A: はい。出席管理画面にリアルタイム反映されます。
