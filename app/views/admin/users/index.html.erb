<%# AdminKit風DataGrid: 検索/絞り込み対応テーブル %>
<div class="max-w-6xl mx-auto space-y-6">
  <%# ページヘッダー %>
  <div class="page-header">
    <div>
      <h1 class="page-title">ユーザー管理</h1>
      <p class="page-subtitle">システムに登録されているユーザーの一覧と管理</p>
      <%= breadcrumb(["管理", admin_path], ["ユーザー"]) %>
    </div>
    <%= link_to "新規ユーザー",
      new_admin_user_path,
      class: "btn btn-primary" %>
  </div>

  <div class="data-grid">
    <%# ツールバー（検索・フィルタ） %>
    <div class="data-grid-toolbar">
      <%= form_with url: admin_users_path,
        method: :get,
        class: "flex flex-wrap items-center gap-3 w-full",
        data: {
          controller: "request-filter",
          action: "change->request-filter#submit input->request-filter#submitDebounced"
        } do |f| %>

        <%# 検索ボックス %>
        <div class="data-grid-search">
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <svg class="h-4 w-4 text-body-muted" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"/>
                <path d="M21 21l-4.35-4.35" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
            <%= f.text_field :q,
              value: @query,
              class: "input pl-10",
              placeholder: "氏名/メール/学籍IDで検索..." %>
          </div>
        </div>

        <%# フィルタ %>
        <div class="data-grid-filters">
          <%= f.select :role,
            options_for_select(User.roles.keys.map { |role| [role, role] }, @role),
            { include_blank: "すべてのロール" },
            class: "input min-w-[140px]" %>

          <%= f.submit "検索", class: "btn btn-secondary" %>

          <% if session[:admin_users_last_filter].present? %>
            <%= link_to "前回条件", admin_users_path(session[:admin_users_last_filter]), class: "btn btn-secondary" %>
          <% end %>
        </div>
      <% end %>
    </div>

    <%# テーブル %>
    <div class="table-container">
      <table class="data-grid-table">
        <thead>
          <tr>
            <th>氏名</th>
            <th>メール</th>
            <th>学籍ID</th>
            <th>ロール</th>
            <th>最終ログイン</th>
            <th class="text-right">操作</th>
          </tr>
        </thead>
        <tbody id="admin_users_rows">
          <%= render partial: "row", collection: @users, as: :user %>
          <% if @users.empty? %>
            <tr id="admin_users_empty">
              <td colspan="6" class="px-4 py-8 text-center">
                <div class="empty-state">
                  <div class="empty-state-title">該当なし</div>
                  <div class="text-sm mt-1 text-body-secondary">検索条件を変更するか、新規ユーザーを追加してください。</div>
                </div>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>

    <%# ページネーション（存在する場合） %>
    <% if @users.respond_to?(:total_pages) && @users.total_pages > 1 %>
      <div class="data-grid-pagination">
        <div class="text-sm text-body-secondary">
          全 <%= @users.total_count %> 件中 <%= @users.offset_value + 1 %>-<%= [@users.offset_value + @users.length, @users.total_count].min %> 件を表示
        </div>
        <div class="flex items-center gap-2">
          <%= link_to "前へ", admin_users_path(page: @users.prev_page, q: @query, role: @role),
            class: "btn btn-secondary text-sm #{@users.first_page? ? 'opacity-50 pointer-events-none' : ''}" %>
          <%= link_to "次へ", admin_users_path(page: @users.next_page, q: @query, role: @role),
            class: "btn btn-secondary text-sm #{@users.last_page? ? 'opacity-50 pointer-events-none' : ''}" %>
        </div>
      </div>
    <% end %>
  </div>

  <%= render "form_frame" %>
</div>
