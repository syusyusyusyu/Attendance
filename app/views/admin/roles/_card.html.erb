<%# AdminKit風ロールカード: 権限チェックボックス、即時反映 %>
<%= turbo_frame_tag dom_id(role) do %>
  <div class="card">
    <div class="card-header">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <div>
          <h2 class="text-lg font-semibold" style="color: var(--color-text-primary);"><%= role.label %></h2>
          <p class="text-xs" style="color: var(--color-text-muted);">key: <%= role.name %></p>
        </div>
        <% if role.updated_at %>
          <p class="text-xs" style="color: var(--color-text-muted);">更新: <%= l(role.updated_at, format: :short) %></p>
        <% end %>
      </div>
    </div>
    <div class="card-body">
      <% if local_assigns[:error_message].present? %>
        <div class="mb-3 text-sm rounded-lg p-3" style="background-color: var(--color-error-light); color: var(--color-error-dark);">権限の更新に失敗しました: <%= error_message %></div>
      <% end %>

      <%= form_with url: admin_role_path(role), method: :patch, scope: :role do |f| %>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div>
            <%= f.label :label, "表示名", class: "block text-sm font-medium mb-2", style: "color: var(--color-text-primary);" %>
            <%= f.text_field :label, value: role.label, class: "input" %>
          </div>
          <div>
            <%= f.label :description, "説明", class: "block text-sm font-medium mb-2", style: "color: var(--color-text-primary);" %>
            <%= f.text_field :description, value: role.description, class: "input" %>
          </div>
        </div>

        <div class="mb-4">
          <label class="block text-sm font-medium mb-3" style="color: var(--color-text-primary);">権限</label>
          <% category_labels = {
            "admin" => "管理",
            "attendance" => "出席",
            "qr" => "QR",
            "reports" => "レポート",
            "classes" => "クラス",
            "enrollments" => "履修",
            "session" => "授業回",
            "notifications" => "通知",
            "profile" => "プロフィール",
            "history" => "出席履歴",
            "scan" => "スキャン"
          } %>
          <% category_order = category_labels.keys %>
          <% grouped = permissions.group_by { |permission| permission.key.to_s.split(".").first } %>

          <div class="space-y-3">
            <% category_order.each do |category| %>
              <% group_permissions = grouped[category] || [] %>
              <% next if group_permissions.empty? %>
              <details open class="rounded-lg" style="border: 1px solid var(--color-border); background-color: var(--color-surface);">
                <summary class="cursor-pointer px-4 py-3 flex items-center justify-between">
                  <span class="text-sm font-semibold" style="color: var(--color-text-primary);"><%= category_labels[category] %></span>
                  <span class="badge badge-neutral"><%= group_permissions.size %></span>
                </summary>
                <div class="px-4 pb-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                  <% group_permissions.each do |permission| %>
                    <label class="flex items-center gap-2 text-sm" style="color: var(--color-text-primary);">
                      <%= check_box_tag "permission_ids[]", permission.id, role.permissions.exists?(permission.id), class: "h-4 w-4 rounded", style: "border-color: var(--color-border); accent-color: var(--color-primary);" %>
                      <span><%= permission.label %></span>
                    </label>
                  <% end %>
                </div>
              </details>
            <% end %>
          </div>
        </div>

        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 pt-4" style="border-top: 1px solid var(--color-border);">
          <span class="text-xs" style="color: var(--color-text-muted);">権限を変更して保存すると即時反映されます。</span>
          <%= f.submit "更新する", class: "btn btn-primary sm:w-auto w-full" %>
        </div>
      <% end %>
    </div>
  </div>
<% end %>
