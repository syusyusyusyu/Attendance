<% status_options = [["出席", "present"], ["遅刻", "late"], ["欠席", "absent"], ["公欠", "excused"]] %>

<div class="max-w-6xl mx-auto">
  <div class="card">
    <div class="p-4 bg-google-grey border-b border-gray-200">
      <h2 class="text-xl font-medium text-gray-800 flex items-center">
        <svg class="mr-2 text-google-green" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="8" y="2" width="8" height="4" rx="1" />
          <rect x="6" y="4" width="12" height="18" rx="2" />
          <path d="M9 11h6M9 15h6" stroke-linecap="round" stroke-linejoin="round" />
        </svg>
        クラス出席管理
      </h2>
      <p class="text-sm text-gray-500 mt-1">クラスと日付を選択して出席状況を更新します。</p>
    </div>

    <div class="p-6 space-y-6">
      <%= form_with url: attendance_path, method: :get, class: "grid grid-cols-1 md:grid-cols-3 gap-4 items-end" do |f| %>
        <div>
          <%= f.label :class_id, "クラス", class: "block text-sm font-medium text-gray-700" %>
          <%= f.select :class_id,
            options_from_collection_for_select(@classes, :id, :name, @selected_class&.id),
            { include_blank: "クラスを選択" },
            class: "input mt-1" %>
        </div>
        <div>
          <%= f.label :date, "日付", class: "block text-sm font-medium text-gray-700" %>
          <%= f.date_field :date, value: @date, class: "input mt-1" %>
        </div>
        <div>
          <%= f.submit "表示", class: "btn btn-primary w-full" %>
        </div>
      <% end %>

      <% if @selected_class %>
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
          <div>
            <h3 class="text-lg font-medium text-gray-900"><%= @selected_class.name %></h3>
            <p class="text-sm text-gray-500"><%= @selected_class.subject %> ・ <%= @selected_class.room %></p>
          </div>
          <div class="text-sm text-gray-500"><%= @date.strftime("%Y-%m-%d") %></div>
        </div>

        <%= form_with url: attendance_path, method: :patch, class: "space-y-4" do |f| %>
          <%= hidden_field_tag :class_id, @selected_class.id %>
          <%= hidden_field_tag :date, @date %>

          <div class="table-container">
            <table class="min-w-full divide-y divide-gray-200 text-sm">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">学生ID</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">氏名</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">出席状況</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                <% @students.each do |student| %>
                  <% record = @records[student.id] %>
                  <tr>
                    <td class="px-4 py-3 text-gray-500"><%= student.student_id %></td>
                    <td class="px-4 py-3">
                      <div class="text-gray-900 font-medium"><%= student.name %></div>
                    </td>
                    <td class="px-4 py-3">
                      <%= select_tag "attendance[#{student.id}]",
                        options_for_select(status_options, record&.status || "absent"),
                        class: "input max-w-[160px]" %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>

          <div class="flex justify-end">
            <%= f.submit "更新", class: "btn btn-primary" %>
          </div>
        <% end %>
      <% else %>
        <div class="text-center text-gray-500 py-8">
          クラスを選択すると出席一覧が表示されます。
        </div>
      <% end %>
    </div>
  </div>
</div>
