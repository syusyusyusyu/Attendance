
<% prev_date = @date - 1.day %>
<% next_date = @date + 1.day %>

<div class="max-w-6xl mx-auto">
  <div class="card">
    <div class="p-4 bg-google-grey border-b border-gray-200">
      <h2 class="text-xl font-medium text-gray-800">クラス出席管理</h2>
      <p class="text-sm text-gray-500 mt-1">クラスと日付を選択して出席状況を更新します。</p>
    </div>

    <div class="p-6 space-y-6">
      <%= form_with url: attendance_path, method: :get, class: "grid grid-cols-1 md:grid-cols-2 gap-4" do |f| %>
        <div>
          <%= f.label :class_id, "クラス", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= f.select :class_id,
            options_for_select(@classes.map { |klass| ["#{klass.name} (#{klass.room})", klass.id] }, @selected_class&.id),
            { include_blank: "クラスを選択" },
            class: "input" %>
        </div>
        <div>
          <%= f.label :date, "日付", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <div class="flex">
            <%= link_to attendance_path(class_id: @selected_class&.id, date: prev_date), class: "px-3 py-2 bg-white border border-gray-300 rounded-l-md hover:bg-gray-50" do %>
              <svg class="h-4 w-4 text-gray-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M15 18l-6-6 6-6" stroke-linecap="round" stroke-linejoin="round" />
              </svg>
            <% end %>
            <%= f.date_field :date, value: @date, class: "flex-1 py-2 px-3 border-t border-b border-gray-300 focus:ring-[var(--google-green)] focus:border-[var(--google-green)]" %>
            <%= link_to attendance_path(class_id: @selected_class&.id, date: next_date), class: "px-3 py-2 bg-white border border-gray-300 rounded-r-md hover:bg-gray-50" do %>
              <svg class="h-4 w-4 text-gray-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 6l6 6-6 6" stroke-linecap="round" stroke-linejoin="round" />
              </svg>
            <% end %>
          </div>
        </div>
        <div class="md:col-span-2">
          <%= f.submit "表示", class: "btn btn-primary w-full" %>
        </div>
      <% end %>

      <% if @selected_class %>
        <div class="border border-gray-200 rounded-lg p-4">
          <h3 class="text-sm font-medium text-gray-700 mb-3">出席ポリシー</h3>
          <p class="text-xs text-gray-500 mb-4">
            授業時間: <%= @selected_class.schedule_label || "未設定" %>
          </p>
          <%= form_with url: attendance_policy_path, method: :patch, scope: :attendance_policy, class: "grid grid-cols-1 md:grid-cols-3 gap-4 items-end" do |f| %>
            <%= hidden_field_tag :class_id, @selected_class.id %>
            <%= hidden_field_tag :date, @date %>
            <div>
              <%= f.label :late_after_minutes, "遅刻判定(分)", class: "block text-sm font-medium text-gray-700 mb-2" %>
              <%= f.number_field :late_after_minutes, value: @policy.late_after_minutes, min: 0, class: "input" %>
            </div>
            <div>
              <%= f.label :close_after_minutes, "締切(分)", class: "block text-sm font-medium text-gray-700 mb-2" %>
              <%= f.number_field :close_after_minutes, value: @policy.close_after_minutes, min: 0, class: "input" %>
            </div>
            <div>
              <%= f.label :max_scans_per_minute, "分間スキャン上限", class: "block text-sm font-medium text-gray-700 mb-2" %>
              <%= f.number_field :max_scans_per_minute, value: @policy.max_scans_per_minute, min: 1, class: "input" %>
            </div>
            <div class="flex items-center space-x-2">
              <%= f.check_box :allow_early_checkin, { checked: @policy.allow_early_checkin }, true, false %>
              <%= f.label :allow_early_checkin, "開始前の出席登録を許可", class: "text-sm text-gray-700" %>
            </div>
            <div class="md:col-span-3">
              <%= f.label :allowed_ip_ranges, "許可IP(任意)", class: "block text-sm font-medium text-gray-700 mb-2" %>
              <%= f.text_area :allowed_ip_ranges, value: @policy.allowed_ip_ranges, rows: 2, class: "input", placeholder: "例: 192.168.0.0/24, 10.0.0.0/8" %>
            </div>
            <div class="md:col-span-3">
              <%= f.label :allowed_user_agent_keywords, "許可端末キーワード(任意)", class: "block text-sm font-medium text-gray-700 mb-2" %>
              <%= f.text_area :allowed_user_agent_keywords, value: @policy.allowed_user_agent_keywords, rows: 2, class: "input", placeholder: "例: iPhone, Android, Chrome" %>
            </div>
            <div class="md:col-span-3">
              <%= f.submit "ポリシー更新", class: "btn btn-secondary w-full" %>
            </div>
          <% end %>
          <p class="text-xs text-gray-500 mt-2">
            遅刻は授業開始+遅刻判定分、締切は授業開始+締切分で判定します。
          </p>
          <p class="text-xs text-gray-500">
            IP/端末制限を設定すると条件に一致しないQRスキャンはブロックされます。
          </p>
        </div>

        <div class="border border-gray-200 rounded-lg p-4">
          <h3 class="text-sm font-medium text-gray-700 mb-3">選択日スケジュール</h3>
          <% if @session_window&.dig(:canceled) %>
            <div class="text-sm text-red-600">この日は休講設定です。</div>
            <% if @session_window[:override]&.note.present? %>
              <div class="text-xs text-gray-500 mt-2">メモ: <%= @session_window[:override].note %></div>
            <% end %>
          <% elsif @session_window.present? %>
            <div class="text-sm text-gray-700">
              <%= @session_window[:start_at].strftime("%H:%M") %> - <%= @session_window[:end_at].strftime("%H:%M") %>
              <% if @session_window[:status].present? %>
                <% label = { "regular" => "通常", "makeup" => "補講" }[@session_window[:status]] || @session_window[:status] %>
                <span class="ml-2 text-xs text-gray-500">(<%= label %>)</span>
              <% end %>
            </div>
            <% if @session_window[:override]&.note.present? %>
              <div class="text-xs text-gray-500 mt-2">メモ: <%= @session_window[:override].note %></div>
            <% end %>
          <% else %>
            <div class="text-sm text-gray-500">スケジュールが未設定です。</div>
          <% end %>
        </div>

        <div class="border border-gray-200 rounded-lg p-4">
          <h3 class="text-sm font-medium text-gray-700 mb-3">CSVエクスポート</h3>
          <%= form_with url: attendance_export_path, method: :get, class: "grid grid-cols-1 md:grid-cols-3 gap-4 items-end" do |f| %>
            <%= hidden_field_tag :class_id, @selected_class.id %>
            <div>
              <%= f.label :start_date, "開始日", class: "block text-sm font-medium text-gray-700 mb-2" %>
              <%= f.date_field :start_date, value: @date, class: "input" %>
            </div>
            <div>
              <%= f.label :end_date, "終了日", class: "block text-sm font-medium text-gray-700 mb-2" %>
              <%= f.date_field :end_date, value: @date, class: "input" %>
            </div>
            <div>
              <%= f.submit "CSVダウンロード", class: "btn btn-secondary w-full" %>
            </div>
          <% end %>
          <p class="text-xs text-gray-500 mt-2">開始日と終了日を同じ日にすると、1日分のみ出力します。</p>
        </div>

        <div class="border border-gray-200 rounded-lg p-4">
          <h3 class="text-sm font-medium text-gray-700 mb-3">CSVインポート</h3>
          <%= form_with url: attendance_import_path, method: :post, multipart: true, class: "grid grid-cols-1 md:grid-cols-3 gap-4 items-end" do |f| %>
            <%= hidden_field_tag :class_id, @selected_class.id %>
            <%= hidden_field_tag :date, @date %>
            <div class="md:col-span-2">
              <%= f.label :csv_file, "CSVファイル", class: "block text-sm font-medium text-gray-700 mb-2" %>
              <%= f.file_field :csv_file, accept: ".csv", class: "input" %>
            </div>
            <div>
              <%= f.submit "CSVインポート", class: "btn btn-secondary w-full" %>
            </div>
          <% end %>
          <p class="text-xs text-gray-500 mt-2">
            必須列: 日付 / 学生ID / 出席状況(出席・遅刻・欠席・公欠)。備考は任意です。
          </p>
        </div>
      <% end %>

      <% if @selected_class %>
        <div data-controller="attendance" data-attendance-editing-value="false">
          <%= turbo_stream_from "attendance_class_#{@selected_class.id}_#{@date}" %>
          <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-4">
            <div>
              <h3 class="text-lg font-medium text-gray-900"><%= @selected_class.name %></h3>
              <p class="text-sm text-gray-500">教室: <%= @selected_class.room %></p>
            </div>
            <div class="flex items-center space-x-2">
              <button type="button" class="btn btn-blue" data-attendance-target="editButton" data-action="attendance#edit">
                <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 20h9" stroke-linecap="round" stroke-linejoin="round" />
                  <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4Z" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                編集
              </button>
            </div>
          </div>

          <div class="mb-4">
            <div class="relative">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <svg class="h-4 w-4 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="11" cy="11" r="7" />
                  <path d="M21 21l-4.3-4.3" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
              </div>
              <input
                type="text"
                class="input pl-10"
                placeholder="学生ID / 氏名で検索..."
                data-attendance-target="search"
                data-action="input->attendance#filter"
              />
            </div>
          </div>

          <%= form_with url: attendance_path, method: :patch, class: "space-y-4" do |f| %>
            <%= hidden_field_tag :class_id, @selected_class.id %>
            <%= hidden_field_tag :date, @date %>

            <div class="border border-gray-200 rounded-lg p-4 hidden" data-attendance-target="reasonBlock">
              <%= label_tag :reason, "修正理由", class: "block text-sm font-medium text-gray-700 mb-2" %>
              <%= text_area_tag :reason, nil, rows: 2, class: "input", placeholder: "例: 公欠申請・遅延連絡" %>
              <p class="text-xs text-gray-500 mt-2">出席状況を変更する場合は理由の入力が必須です。</p>
            </div>

            <div class="table-container">
              <table class="min-w-full divide-y divide-gray-200 text-sm">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">学生ID</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">氏名</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">出席状況</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  <% @students.each do |student| %>
                    <%= render "attendance_row", student: student, record: @records[student.id] %>
                  <% end %>
                </tbody>
              </table>
            </div>

            <div class="flex justify-end space-x-2">
              <button type="button" class="btn btn-secondary hidden" data-attendance-target="cancelButton" data-action="attendance#cancel">
                キャンセル
              </button>
              <%= f.submit "保存", class: "btn btn-primary hidden", data: { attendance_target: "saveButton" } %>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="text-center text-gray-500 py-8">
          クラスを選択すると出席一覧が表示されます。
        </div>
      <% end %>
    </div>
  </div>
</div>

