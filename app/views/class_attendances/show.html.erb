<%# AdminKit風出席確認: DataGrid、ポリシー設定、CSV入出力 %>
<% prev_date = @date - 1.day %>
<% next_date = @date + 1.day %>

<div class="max-w-6xl mx-auto space-y-6">
  <%# ページヘッダー %>
  <div class="page-header sticky top-[calc(var(--app-header-height)+1rem)] z-20">
    <div>
      <h1 class="page-title">クラス出席管理</h1>
      <p class="page-subtitle">クラスと日付を選択して出席状況を更新します。</p>
      <%= breadcrumb(["出席確認"]) %>
    </div>
  </div>

  <%# クラス・日付選択カード %>
  <div class="card">
    <div class="card-header">
      <h2 class="font-semibold">クラス・日付選択</h2>
    </div>
    <div class="card-body">
      <%= form_with url: attendance_path,
        method: :get,
        class: "grid grid-cols-1 md:grid-cols-2 gap-4",
        data: {
          controller: "request-filter",
          action: "change->request-filter#submit input->request-filter#submitDebounced"
        } do |f| %>
        <div>
          <%= f.label :class_id, "クラス", class: "block text-sm font-medium mb-2", style: "color: var(--color-text-primary);" %>
          <%= f.select :class_id,
            options_for_select(@classes.map { |klass| ["#{klass.name} (#{klass.room})", klass.id] }, @selected_class&.id),
            { include_blank: "クラスを選択" },
            class: "input" %>
        </div>
        <div>
          <%= f.label :date, "日付", class: "block text-sm font-medium mb-2", style: "color: var(--color-text-primary);" %>
          <div class="flex">
            <%= link_to attendance_path(class_id: @selected_class&.id, date: prev_date), class: "px-3 py-2 border rounded-l-md hover:bg-[var(--color-surface-hover)]", style: "background-color: var(--color-surface); border-color: var(--color-border);" do %>
              <svg class="h-4 w-4 text-body-muted" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M15 18l-6-6 6-6" stroke-linecap="round" stroke-linejoin="round" />
              </svg>
            <% end %>
            <%= f.date_field :date, value: @date, class: "flex-1 py-2 px-3 border-t border-b focus:outline-none focus:ring-2", style: "border-color: var(--color-border); --tw-ring-color: var(--color-primary);" %>
            <%= link_to attendance_path(class_id: @selected_class&.id, date: next_date), class: "px-3 py-2 border rounded-r-md hover:bg-[var(--color-surface-hover)]", style: "background-color: var(--color-surface); border-color: var(--color-border);" do %>
              <svg class="h-4 w-4 text-body-muted" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 6l6 6-6 6" stroke-linecap="round" stroke-linejoin="round" />
              </svg>
            <% end %>
          </div>
        </div>
        <div class="md:col-span-2 flex flex-col sm:flex-row gap-2">
          <%= f.submit "表示", class: "btn btn-primary w-full" %>
          <% if session[:attendance_class_id].present? || session[:attendance_date].present? %>
            <%= link_to "前回条件",
              attendance_path(class_id: session[:attendance_class_id], date: session[:attendance_date]),
              class: "btn btn-secondary w-full" %>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>

  <% if @selected_class %>
    <%# 管理者承認案内 %>
    <div class="not-implemented-banner">
      <svg class="not-implemented-banner-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20z"/>
        <path d="M12 8v4l3 3"/>
      </svg>
      <span class="not-implemented-banner-text">出席修正/確定/解除は管理者の最終承認が必要です。</span>
    </div>

    <%# 出席ポリシーカード %>
    <div class="card">
      <div class="card-header">
        <h2 class="font-semibold">出席ポリシー</h2>
      </div>
      <div class="card-body">
        <p class="text-sm mb-4 text-body-secondary">
          授業時間: <%= @selected_class.schedule_label || "未設定" %>
        </p>
        <%= form_with url: attendance_policy_path, method: :patch, scope: :attendance_policy, class: "grid grid-cols-1 md:grid-cols-3 gap-4 items-end" do |f| %>
          <%= hidden_field_tag :class_id, @selected_class.id %>
          <%= hidden_field_tag :date, @date %>
          <div>
            <span class="block text-sm font-medium mb-2">出席判定</span>
            <div class="text-sm text-body-secondary">出席QRを発行してスキャンした記録は出席扱い</div>
            <%= f.hidden_field :late_after_minutes, value: AttendancePolicy::DEFAULTS[:late_after_minutes] %>
          </div>
          <div>
            <span class="block text-sm font-medium mb-2">欠席判定</span>
            <div class="text-sm text-body-secondary">授業開始20分以降は欠席</div>
            <%= f.hidden_field :close_after_minutes, value: AttendancePolicy::DEFAULTS[:close_after_minutes] %>
          </div>
          <div>
            <%= f.label :minimum_attendance_rate, "最低出席率(%)", class: "block text-sm font-medium mb-2", style: "color: var(--color-text-primary);" %>
            <%= f.number_field :minimum_attendance_rate, value: @policy.minimum_attendance_rate, min: 0, max: 100, class: "input" %>
          </div>
          <div>
            <%= f.label :warning_absent_count, "警告欠席回数", class: "block text-sm font-medium mb-2", style: "color: var(--color-text-primary);" %>
            <%= f.number_field :warning_absent_count, value: @policy.warning_absent_count, min: 0, class: "input" %>
          </div>
          <div>
            <%= f.label :warning_rate_percent, "警告出席率(%)", class: "block text-sm font-medium mb-2", style: "color: var(--color-text-primary);" %>
            <%= f.number_field :warning_rate_percent, value: @policy.warning_rate_percent, min: 0, max: 100, class: "input" %>
          </div>
          <div class="flex items-center gap-2">
            <%= f.check_box :allow_early_checkin, { checked: @policy.allow_early_checkin, class: "h-4 w-4 rounded", style: "border-color: var(--color-border); accent-color: var(--color-primary);" }, true, false %>
            <%= f.label :allow_early_checkin, "開始前の出席登録を許可", class: "text-sm", style: "color: var(--color-text-primary);" %>
          </div>
          <div class="flex items-center gap-2">
            <%= f.check_box :require_location, { checked: true, disabled: true, class: "h-4 w-4 rounded", style: "border-color: var(--color-border); accent-color: var(--color-primary);" }, true, false %>
            <%= f.label :require_location, "位置情報の取得は必須（OIC校内限定）", class: "text-sm", style: "color: var(--color-text-primary);" %>
          </div>
          <div class="flex items-center gap-2">
            <%= f.check_box :geo_fence_enabled, { checked: true, disabled: true, class: "h-4 w-4 rounded", style: "border-color: var(--color-border); accent-color: var(--color-primary);" }, true, false %>
            <%= f.label :geo_fence_enabled, "校内ジオフェンスを固定", class: "text-sm", style: "color: var(--color-text-primary);" %>
          </div>
          <% if current_user.admin? %>
            <div class="md:col-span-3">
              <div class="rounded-lg p-4 bg-surface-hover">
                <div class="font-medium">位置情報は大阪情報コンピュータ専門学校に固定</div>
                <div class="mt-2 text-sm text-body-secondary">〒543-0001 大阪府大阪市天王寺区上本町6-8-4</div>
                <div class="text-xs mt-1 text-body-muted">校内半径50mで判定します。</div>
              </div>
            </div>
          <% end %>
          <div>
            <%= f.label :geo_radius_m, "許可半径(m)", class: "block text-sm font-medium mb-2", style: "color: var(--color-text-primary);" %>
            <%= f.number_field :geo_radius_m, value: @policy.geo_radius_m, min: 1, class: "input", disabled: true %>
          </div>
          <div class="md:col-span-3">
            <%= f.label :allowed_ip_ranges, "許可IP(任意)", class: "block text-sm font-medium mb-2", style: "color: var(--color-text-primary);" %>
            <%= f.text_area :allowed_ip_ranges, value: @policy.allowed_ip_ranges, rows: 2, class: "input", placeholder: "例: 192.168.0.0/24, 10.0.0.0/8" %>
          </div>
          <div class="md:col-span-3">
            <%= f.submit "ポリシー更新", class: "btn btn-secondary w-full" %>
          </div>
        <% end %>
        <div class="mt-4 space-y-1">
          <p class="text-xs text-body-muted">出席QRのスキャンは出席扱いです。授業開始20分以降は欠席として扱います。</p>
          <p class="text-xs text-body-muted">IP制限を設定すると条件に一致しないQRスキャンはブロックされます。</p>
          <p class="text-xs text-body-muted">位置情報は必須のため、取得できない端末は出席登録できません。</p>
          <p class="text-xs text-body-muted">校内の中心と半径の範囲外のスキャンは拒否されます。</p>
          <p class="text-xs text-body-muted">最低出席率は入室/退室の滞在時間に基づき早退判定に利用されます。</p>
          <p class="text-xs text-body-muted">警告欠席回数・警告出席率はダッシュボードの注意アラートに反映されます。</p>
        </div>
      </div>
    </div>

    <%# スケジュール・ステータス・CSV %>
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <%# 選択日スケジュール %>
      <div class="card">
        <div class="card-header">
          <h3 class="font-semibold">選択日スケジュール</h3>
        </div>
        <div class="card-body">
          <% if @session_window&.dig(:canceled) %>
            <div class="text-sm text-error">この日は休講設定です。</div>
            <% if @session_window[:override]&.note.present? %>
              <div class="text-xs mt-2 text-body-muted">メモ: <%= @session_window[:override].note %></div>
            <% end %>
          <% elsif @session_window.present? %>
            <div class="text-sm">
              <%= @session_window[:start_at].strftime("%H:%M") %> - <%= @session_window[:end_at].strftime("%H:%M") %>
            </div>
            <% if @class_session %>
              <div class="mt-2">
                <%= render "shared/session_status_badges", session: @class_session %>
              </div>
            <% end %>
            <% if @session_window[:override]&.note.present? %>
              <div class="text-xs mt-2 text-body-muted">メモ: <%= @session_window[:override].note %></div>
            <% end %>
          <% else %>
            <div class="text-sm text-body-muted">スケジュールが未設定です。</div>
          <% end %>
        </div>
      </div>

      <%# 授業回ステータス %>
      <div class="card">
        <div class="card-header">
          <h3 class="font-semibold">授業回ステータス</h3>
        </div>
        <div class="card-body">
          <% if @class_session %>
            <div class="text-sm text-body-secondary">授業回ID: <%= @class_session.id %></div>
            <div class="mt-2">
              <%= render "shared/session_status_badges", session: @class_session %>
            </div>
            <% if @class_session.locked? %>
              <div class="mt-2 text-sm text-success">出席は確定済みです。</div>
              <div class="mt-3">
                <%= button_to(current_user.admin? ? "確定を解除" : "確定解除を申請",
                  attendance_unlock_path(class_id: @selected_class.id, date: @date),
                  method: :patch,
                  data: { turbo_confirm: "出席確定を解除します。よろしいですか？" },
                  class: "btn btn-secondary w-full") %>
              </div>
              <% unless current_user.admin? %>
                <div class="mt-2 text-xs text-body-muted">教員は承認申請となります。</div>
              <% end %>
            <% else %>
              <div class="mt-2 text-sm text-body-secondary">出席は未確定です。</div>
              <% if @finalize_available %>
                <div class="mt-3">
                  <%= button_to(current_user.admin? ? "出席を確定" : "出席確定を申請",
                    attendance_finalize_path(class_id: @selected_class.id, date: @date),
                    method: :patch,
                    data: { turbo_confirm: "出席を確定します。よろしいですか？" },
                    class: "btn btn-primary w-full") %>
                </div>
                <% unless current_user.admin? %>
                  <div class="mt-2 text-xs text-body-muted">教員は承認申請となります。</div>
                <% end %>
              <% else %>
                <div class="mt-2 text-xs text-body-muted">授業終了後に確定できます。</div>
              <% end %>
            <% end %>
          <% else %>
            <div class="text-sm text-body-muted">授業回が未生成です。スケジュールを設定してください。</div>
          <% end %>
        </div>
      </div>

      <%# CSVエクスポート %>
      <div class="card">
        <div class="card-header">
          <h3 class="font-semibold">CSVエクスポート</h3>
        </div>
        <div class="card-body">
          <%= form_with url: attendance_export_path, method: :get, class: "space-y-3" do |f| %>
            <%= hidden_field_tag :class_id, @selected_class.id %>
            <div class="grid grid-cols-2 gap-2">
              <div>
                <%= f.label :start_date, "開始日", class: "block text-xs font-medium mb-1", style: "color: var(--color-text-primary);" %>
                <%= f.date_field :start_date, value: @date, class: "input text-sm" %>
              </div>
              <div>
                <%= f.label :end_date, "終了日", class: "block text-xs font-medium mb-1", style: "color: var(--color-text-primary);" %>
                <%= f.date_field :end_date, value: @date, class: "input text-sm" %>
              </div>
            </div>
            <%= f.submit "CSVダウンロード", class: "btn btn-secondary w-full text-sm" %>
          <% end %>
          <p class="text-xs mt-2 text-body-muted">同日を指定すると1日分のみ出力</p>
        </div>
      </div>
    </div>

    <%# CSVインポート %>
    <div class="card">
      <div class="card-header">
        <h3 class="font-semibold">CSVインポート</h3>
      </div>
      <div class="card-body">
        <%= form_with url: attendance_import_path, method: :post, multipart: true, class: "grid grid-cols-1 md:grid-cols-3 gap-4 items-end" do |f| %>
          <%= hidden_field_tag :class_id, @selected_class.id %>
          <%= hidden_field_tag :date, @date %>
          <div class="md:col-span-2">
            <%= f.label :csv_file, "CSVファイル", class: "block text-sm font-medium mb-2", style: "color: var(--color-text-primary);" %>
            <%= f.file_field :csv_file, accept: ".csv", class: "input" %>
          </div>
          <div>
            <%= f.submit(current_user.admin? ? "CSVインポート" : "CSVインポート申請",
              class: "btn btn-secondary w-full",
              data: { turbo_confirm: "CSVを反映します。よろしいですか？" }) %>
          </div>
        <% end %>
        <p class="text-xs mt-2 text-body-muted">
          必須列: 日付 / 学生ID / 出席状況(出席・遅刻・欠席・公欠)。備考は任意です。
        </p>
        <% unless current_user.admin? %>
          <p class="text-xs text-body-muted">教員は承認申請として登録されます。</p>
        <% end %>
      </div>
    </div>

    <%# 出席一覧 %>
    <div class="card" data-controller="attendance" data-attendance-editing-value="false">
      <%= turbo_stream_from "attendance_class_#{@selected_class.id}_#{@date}" %>
      <div class="card-header">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
          <div>
            <h3 class="text-lg font-semibold"><%= @selected_class.name %></h3>
            <p class="text-sm text-body-secondary">教室: <%= @selected_class.room %></p>
          </div>
          <button type="button" class="btn btn-primary" data-attendance-target="editButton" data-action="attendance#edit">
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 20h9" stroke-linecap="round" stroke-linejoin="round" />
              <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4Z" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
            編集
          </button>
        </div>
      </div>

      <%# 変更バナー %>
      <div class="sticky top-[calc(var(--app-header-height)+0.5rem)] z-10 hidden px-4" data-attendance-target="changeBanner">
        <div class="rounded-lg px-4 py-2 text-sm shadow-sm bg-warning-light border border-[var(--color-warning)]">
          <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
            <div class="font-medium">変更中: <span data-attendance-target="changeCount">0</span>件</div>
            <div class="text-xs truncate text-body-secondary" data-attendance-target="changeList"></div>
          </div>
        </div>
      </div>

      <div class="card-body">
        <%# 検索・フィルター %>
        <div class="mb-4 flex flex-col sm:flex-row gap-2">
          <div class="relative flex-1">
            <svg class="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-body-muted pointer-events-none" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="7" />
              <path d="M21 21l-4.3-4.3" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
            <input
              type="text"
              class="input input-search"
              placeholder="学生ID / 氏名で検索..."
              data-attendance-target="search"
              data-action="input->attendance#filter"
            />
          </div>
          <div class="sm:w-48">
            <select class="input" data-attendance-target="statusFilter" data-action="change->attendance#filter">
              <option value="">すべて</option>
              <option value="missing">未入力</option>
              <option value="present">出席</option>
              <option value="late">遅刻</option>
              <option value="early_leave">早退</option>
              <option value="absent">欠席</option>
              <option value="excused">公欠</option>
              <option value="pending_request">申請中</option>
            </select>
          </div>
        </div>

        <%= form_with url: attendance_path, method: :patch, class: "space-y-4",
          data: { action: "turbo:submit-end->attendance#submitEnd" } do |f| %>
          <%= hidden_field_tag :class_id, @selected_class.id %>
          <%= hidden_field_tag :date, @date %>

          <%# 修正理由 %>
          <div
            class="rounded-lg p-4 hidden drawer-panel"

            data-attendance-target="reasonBlock"
            data-controller="drawer"
            data-drawer-open-value="false"
          >
            <%= label_tag :reason, "修正理由", class: "block text-sm font-medium mb-2", style: "color: var(--color-text-primary);" %>
            <%= text_area_tag :reason, nil, rows: 2, class: "input", placeholder: "例: 公欠申請・遅延連絡" %>
            <p class="text-xs mt-2 text-body-muted">出席状況を変更する場合は理由の入力が必須です。</p>
          </div>

          <%# テーブル %>
          <div class="table-container">
            <table class="w-full">
              <thead>
                <tr>
                  <th>学生ID</th>
                  <th>氏名</th>
                  <th>出席状況</th>
                  <th>入室</th>
                  <th>退室</th>
                  <th>滞在(分)</th>
                  <th>申請</th>
                </tr>
              </thead>
              <tbody>
                <% @students.each do |student| %>
                  <%= render "attendance_row",
                    student: student,
                    record: @records[student.id],
                    request: @pending_requests[student.id],
                    policy: @policy,
                    class_session: @class_session %>
                <% end %>
              </tbody>
            </table>
          </div>

          <div class="flex justify-end gap-2">
            <button type="button" class="btn btn-secondary hidden" data-attendance-target="cancelButton" data-action="attendance#cancel">
              キャンセル
            </button>
            <%= f.submit "保存", class: "btn btn-primary hidden", data: { attendance_target: "saveButton" } %>
          </div>
        <% end %>
      </div>
    </div>
  <% else %>
    <div class="card">
      <div class="card-body">
        <div class="empty-state">
          <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2"/>
            <rect x="9" y="3" width="6" height="4" rx="1"/>
          </svg>
          <div class="empty-state-title">クラスを選択すると出席一覧が表示されます。</div>
        </div>
      </div>
    </div>
  <% end %>
</div>
