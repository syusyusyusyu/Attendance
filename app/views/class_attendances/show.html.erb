<% status_labels = {
  "present" => "出席",
  "late" => "遅刻",
  "absent" => "欠席",
  "excused" => "公欠"
} %>
<% status_badges = {
  "present" => "badge badge-success",
  "late" => "badge badge-warning",
  "absent" => "badge badge-error",
  "excused" => "badge badge-info"
} %>
<% prev_date = @date - 1.day %>
<% next_date = @date + 1.day %>

<div class="max-w-6xl mx-auto">
  <div class="card">
    <div class="p-4 bg-google-grey border-b border-gray-200">
      <h2 class="text-xl font-medium text-gray-800">クラス出席管理</h2>
      <p class="text-sm text-gray-500 mt-1">クラスと日付を選択して出席状況を更新します。</p>
    </div>

    <div class="p-6 space-y-6">
      <%= form_with url: attendance_path, method: :get, class: "grid grid-cols-1 md:grid-cols-2 gap-4" do |f| %>
        <div>
          <%= f.label :class_id, "クラス", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= f.select :class_id,
            options_for_select(@classes.map { |klass| ["#{klass.name} (#{klass.room})", klass.id] }, @selected_class&.id),
            { include_blank: "クラスを選択" },
            class: "input" %>
        </div>
        <div>
          <%= f.label :date, "日付", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <div class="flex">
            <%= link_to attendance_path(class_id: @selected_class&.id, date: prev_date), class: "px-3 py-2 bg-white border border-gray-300 rounded-l-md hover:bg-gray-50" do %>
              <svg class="h-4 w-4 text-gray-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M15 18l-6-6 6-6" stroke-linecap="round" stroke-linejoin="round" />
              </svg>
            <% end %>
            <%= f.date_field :date, value: @date, class: "flex-1 py-2 px-3 border-t border-b border-gray-300 focus:ring-[var(--google-green)] focus:border-[var(--google-green)]" %>
            <%= link_to attendance_path(class_id: @selected_class&.id, date: next_date), class: "px-3 py-2 bg-white border border-gray-300 rounded-r-md hover:bg-gray-50" do %>
              <svg class="h-4 w-4 text-gray-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 6l6 6-6 6" stroke-linecap="round" stroke-linejoin="round" />
              </svg>
            <% end %>
          </div>
        </div>
        <div class="md:col-span-2">
          <%= f.submit "表示", class: "btn btn-primary w-full" %>
        </div>
      <% end %>

      <% if @selected_class %>
        <div class="flex justify-end">
          <%= link_to "CSVダウンロード", attendance_export_path(class_id: @selected_class.id, date: @date), class: "btn btn-secondary" %>
        </div>
      <% end %>

      <% if @selected_class %>
        <div data-controller="attendance" data-attendance-editing-value="false">
          <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-4">
            <div>
              <h3 class="text-lg font-medium text-gray-900"><%= @selected_class.name %></h3>
              <p class="text-sm text-gray-500">教室: <%= @selected_class.room %></p>
            </div>
            <div class="flex items-center space-x-2">
              <button type="button" class="btn btn-blue" data-attendance-target="editButton" data-action="attendance#edit">
                <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 20h9" stroke-linecap="round" stroke-linejoin="round" />
                  <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4Z" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                編集
              </button>
            </div>
          </div>

          <div class="mb-4">
            <div class="relative">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <svg class="h-4 w-4 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="11" cy="11" r="7" />
                  <path d="M21 21l-4.3-4.3" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
              </div>
              <input
                type="text"
                class="input pl-10"
                placeholder="学生ID / 氏名で検索..."
                data-attendance-target="search"
                data-action="input->attendance#filter"
              />
            </div>
          </div>

          <%= form_with url: attendance_path, method: :patch, class: "space-y-4" do |f| %>
            <%= hidden_field_tag :class_id, @selected_class.id %>
            <%= hidden_field_tag :date, @date %>

            <div class="table-container">
              <table class="min-w-full divide-y divide-gray-200 text-sm">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">学生ID</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">氏名</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">出席状況</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  <% @students.each do |student| %>
                    <% record = @records[student.id] %>
                    <% status = record&.status || "absent" %>
                    <tr data-attendance-target="row" data-name="<%= student.name %>" data-student-id="<%= student.student_id %>">
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"><%= student.student_id %></td>
                      <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900"><%= student.name %></div>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap">
                        <span class="<%= status_badges[status] %>" data-attendance-target="statusBadge">
                          <%= status_labels[status] %>
                        </span>
                        <%= select_tag "attendance[#{student.id}]",
                          options_for_select(status_labels.map { |key, label| [label, key] }, status),
                          class: "input max-w-[160px] hidden",
                          data: { attendance_target: "statusSelect", initial_value: status } %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>

            <div class="flex justify-end space-x-2">
              <button type="button" class="btn btn-secondary hidden" data-attendance-target="cancelButton" data-action="attendance#cancel">
                キャンセル
              </button>
              <%= f.submit "保存", class: "btn btn-primary hidden", data: { attendance_target: "saveButton" } %>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="text-center text-gray-500 py-8">
          クラスを選択すると出席一覧が表示されます。
        </div>
      <% end %>
    </div>
  </div>
</div>
