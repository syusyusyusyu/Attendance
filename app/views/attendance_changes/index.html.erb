<% status_labels = {
  "present" => "出席",
  "late" => "遅刻",
  "absent" => "欠席",
  "excused" => "公欠",
  "early_leave" => "早退"
} %>
<% source_labels = {
  "manual" => "手動",
  "csv" => "CSV",
  "system" => "自動"
} %>
<% status_badges = {
  "present" => "badge badge-success",
  "late" => "badge badge-warning",
  "absent" => "badge badge-error",
  "excused" => "badge badge-info",
  "early_leave" => "badge badge-warning"
} %>

<div class="max-w-6xl mx-auto">
  <div class="card">
    <div class="p-4 bg-google-grey border-b border-gray-200">
      <h2 class="text-xl font-medium text-gray-800">出席変更ログ</h2>
      <p class="text-sm text-gray-500 mt-1">直近200件まで表示します。</p>
    </div>

    <%= turbo_frame_tag "attendance_changes_results", class: "drawer-panel relative", data: { controller: "drawer", drawer_open_value: true } do %>
    <%= render "shared/frame_loader" %>
    <div class="p-6 space-y-6">
      <%= form_with url: attendance_logs_path,
        method: :get,
        class: "grid grid-cols-1 md:grid-cols-6 gap-4 items-end",
        data: {
          controller: "request-filter",
          action: "change->request-filter#submit input->request-filter#submitDebounced"
        } do |f| %>
        <div>
          <%= f.label :saved_search_id, "保存済み条件", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= f.select :saved_search_id,
            options_for_select(@saved_searches.map { |saved| [saved.name, saved.id] }, params[:saved_search_id]),
            { include_blank: "未選択" },
            class: "input" %>
        </div>
        <div>
          <%= f.label :class_id, "クラス", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= f.select :class_id,
            options_for_select(@classes.map { |klass| ["#{klass.name} (#{klass.room})", klass.id] }, @selected_class&.id),
            { include_blank: "すべて" },
            class: "input" %>
        </div>
        <div>
          <%= f.label :start_date, "開始日", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= f.date_field :start_date, value: @start_date, class: "input" %>
        </div>
        <div>
          <%= f.label :end_date, "終了日", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= f.date_field :end_date, value: @end_date, class: "input" %>
        </div>
        <div>
          <%= f.label :status, "出席判定", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= f.select :status,
            options_for_select(status_labels.map { |key, label| [label, key] }, @status),
            { include_blank: "すべて" },
            class: "input" %>
        </div>
        <div>
          <%= f.label :source, "種別", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= f.select :source,
            options_for_select(source_labels.map { |key, label| [label, key] }, @source),
            { include_blank: "すべて" },
            class: "input" %>
        </div>
        <div>
          <%= f.label :q, "キーワード", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= f.text_field :q, value: @query, class: "input", placeholder: "氏名/学籍番号/理由/クラス" %>
        </div>
        <div class="md:col-span-6 grid grid-cols-1 md:grid-cols-6 gap-2">
          <div class="md:col-span-3 flex flex-col sm:flex-row gap-2">
            <%= f.submit "絞り込む", class: "btn btn-primary w-full sm:w-auto" %>
            <% if session[:attendance_changes_last_filter].present? %>
              <%= link_to "前回条件",
                attendance_logs_path(session[:attendance_changes_last_filter]),
                class: "btn btn-secondary w-full sm:w-auto" %>
            <% end %>
            <%= link_to "CSV出力",
              attendance_logs_path(format: :csv, class_id: @selected_class&.id, start_date: @start_date, end_date: @end_date, status: @status, source: @source, q: @query),
              class: "btn btn-secondary w-full sm:w-auto",
              data: { turbo: false } %>
          </div>
          <div class="md:col-span-3 flex flex-col sm:flex-row gap-2">
            <%= f.text_field :save_search_name, class: "input", placeholder: "条件名を入力" %>
            <label class="inline-flex items-center text-sm text-gray-600 gap-2">
              <%= f.check_box :save_search_default, { checked: false }, "1", "0" %>
              既定にする
            </label>
            <%= f.submit "条件保存", class: "btn btn-secondary w-full sm:w-auto" %>
          </div>
        </div>
      <% end %>

      <% status_counts = @changes.group_by(&:new_status).transform_values(&:count) %>
      <% source_counts = @changes.group_by(&:source).transform_values(&:count) %>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 text-xs text-gray-600">
        <div class="rounded-lg border border-gray-200 bg-white p-3">
          <div class="text-[11px] text-gray-500">表示件数</div>
          <div class="text-sm font-semibold text-gray-900"><%= @changes.size %>件</div>
        </div>
        <div class="rounded-lg border border-gray-200 bg-white p-3">
          <div class="text-[11px] text-gray-500">種別内訳</div>
          <div class="text-xs text-gray-700">
            手動 <%= source_counts["manual"].to_i %> / CSV <%= source_counts["csv"].to_i %> / 自動 <%= source_counts["system"].to_i %>
          </div>
        </div>
        <div class="rounded-lg border border-gray-200 bg-white p-3">
          <div class="text-[11px] text-gray-500">出席判定</div>
          <div class="text-xs text-gray-700">
            出席 <%= status_counts["present"].to_i %> / 遅刻 <%= status_counts["late"].to_i %> / 欠席 <%= status_counts["absent"].to_i %>
          </div>
        </div>
      </div>

      <div class="table-container">
        <table class="min-w-full divide-y divide-gray-200 text-sm">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">概要</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">種別</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <% if @changes.any? %>
              <% @changes.each do |change| %>
                <% timestamp = change.changed_at&.strftime("%Y-%m-%d %H:%M") || "-" %>
                <% actor = change.modified_by&.name || "-" %>
                <% student_name = change.user&.name || "-" %>
                <% student_id = change.user&.student_id || "-" %>
                <% klass_name = change.school_class&.name || "-" %>
                <% change_label = "#{status_labels[change.previous_status] || "-"}→#{status_labels[change.new_status] || change.new_status}" %>
                <% reason = change.reason.presence || "-" %>
                <% summary = "#{timestamp} / 操作者: #{actor} / 学生: #{student_name}(#{student_id}) / クラス: #{klass_name} / 内容: #{change_label} / 理由: #{reason}" %>
                <tr>
                  <td class="px-4 py-2 text-sm text-gray-700">
                    <%= link_to attendance_log_path(change),
                      data: { turbo_frame: "attendance_change_detail" },
                      class: "block max-w-[720px] truncate hover:underline",
                      title: summary do %>
                      <%= summary %>
                    <% end %>
                  </td>
                  <td class="px-4 py-2 text-sm text-gray-500"><%= source_labels[change.source] || change.source %></td>
                </tr>
              <% end %>
            <% else %>
              <tr>
                <td colspan="2" class="px-4 py-6 text-center text-sm text-gray-500">該当なし</td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
    <% end %>
  </div>
</div>

<%= turbo_frame_tag "attendance_change_detail",
  class: "drawer-panel hidden",
  data: { controller: "drawer", drawer_open_value: false } do %>
  <div class="hidden"></div>
<% end %>
