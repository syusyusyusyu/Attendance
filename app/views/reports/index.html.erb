<div class="max-w-6xl mx-auto space-y-6">
  <div class="card p-6">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div>
        <h1 class="text-2xl font-semibold text-gray-900">レポート</h1>
        <p class="text-sm text-gray-500 mt-1">期間内の出席状況を集計します。</p>
      </div>
      <%= form_with url: reports_path, method: :get, class: "flex flex-col sm:flex-row gap-2" do |f| %>
        <%= f.date_field :start_date, value: @start_date, class: "input" %>
        <%= f.date_field :end_date, value: @end_date, class: "input" %>
        <%= f.submit "更新", class: "btn btn-secondary" %>
      <% end %>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <div class="card p-6">
      <h2 class="text-lg font-medium text-gray-900 mb-4">クラス別出席率</h2>
      <div class="space-y-4">
        <% @class_stats.each do |stat| %>
          <div class="border border-gray-200 rounded-lg p-4">
            <div class="flex items-center justify-between">
              <div class="font-medium text-gray-900"><%= stat[:klass].name %></div>
              <div class="text-xs text-gray-500"><%= stat[:rate] %>%</div>
            </div>
            <div class="mt-2 h-2 rounded-full bg-gray-200">
              <div class="h-2 rounded-full bg-google-green" style="width: <%= stat[:rate] %>%"></div>
            </div>
            <div class="mt-2 text-xs text-gray-600">
              出席 <%= stat[:totals][:present] %> / 遅刻 <%= stat[:totals][:late] %> / 公欠 <%= stat[:totals][:excused] %> /
              早退 <%= stat[:totals][:early_leave] %> / 欠席 <%= stat[:totals][:absent] %> / 未入力 <%= stat[:totals][:missing] %>
            </div>
          </div>
        <% end %>
        <% if @class_stats.empty? %>
          <div class="text-sm text-gray-500">集計対象のクラスがありません。</div>
        <% end %>
      </div>
    </div>

    <div class="card p-6">
      <h2 class="text-lg font-medium text-gray-900 mb-4">欠席・早退が多い学生</h2>
      <div class="space-y-3">
        <% @student_ranking.each_with_index do |row, index| %>
          <div class="flex items-center justify-between border border-gray-200 rounded-lg p-3">
            <div>
              <div class="text-sm font-medium text-gray-900"><%= "#{index + 1}. #{row[:user].name}" %></div>
              <div class="text-xs text-gray-500"><%= row[:user].student_id %></div>
            </div>
            <div class="text-sm text-gray-600">欠席/早退 <%= row[:absent] + row[:early_leave] %> 回</div>
          </div>
        <% end %>
        <% if @student_ranking.empty? %>
          <div class="text-sm text-gray-500">対象データがありません。</div>
        <% end %>
      </div>
    </div>
  </div>

  <div class="card p-6">
    <h2 class="text-lg font-medium text-gray-900 mb-4">日別サマリー</h2>
    <div class="space-y-3">
      <% @daily_summary.each do |row| %>
        <% total = row[:present] + row[:late] + row[:excused] + row[:early_leave] + row[:absent] %>
        <div>
          <div class="flex items-center justify-between text-xs text-gray-500">
            <span><%= row[:date].strftime("%Y-%m-%d") %></span>
            <span>合計 <%= total %></span>
          </div>
          <div class="mt-1 h-2 rounded-full bg-gray-200 overflow-hidden flex">
            <% if total > 0 %>
              <div class="bg-google-green" style="width: <%= (row[:present] * 100.0 / total).round(2) %>%"></div>
              <div class="bg-yellow-400" style="width: <%= (row[:late] * 100.0 / total).round(2) %>%"></div>
              <div class="bg-blue-400" style="width: <%= (row[:excused] * 100.0 / total).round(2) %>%"></div>
              <div class="bg-orange-400" style="width: <%= (row[:early_leave] * 100.0 / total).round(2) %>%"></div>
              <div class="bg-red-400" style="width: <%= (row[:absent] * 100.0 / total).round(2) %>%"></div>
            <% end %>
          </div>
          <div class="text-xs text-gray-500 mt-1">
            出席 <%= row[:present] %> / 遅刻 <%= row[:late] %> / 公欠 <%= row[:excused] %> / 早退 <%= row[:early_leave] %> / 欠席 <%= row[:absent] %>
          </div>
        </div>
      <% end %>
      <% if @daily_summary.empty? %>
        <div class="text-sm text-gray-500">日別データがありません。</div>
      <% end %>
    </div>
  </div>
</div>
