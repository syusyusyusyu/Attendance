<%# AdminKit風QRスキャンログ: DataGrid、バッジ、フィルター %>
<% status_labels = {
  "success" => "成功",
  "checkout" => "退室",
  "checkout_duplicate" => "退室済み",
  "duplicate" => "重複",
  "invalid" => "無効",
  "expired" => "期限切れ",
  "revoked" => "失効",
  "not_enrolled" => "未履修",
  "session_missing" => "セッション不明",
  "no_schedule" => "予定なし",
  "session_locked" => "確定済み",
  "wrong_date" => "日付不一致",
  "error" => "エラー",
  "early" => "開始前",
  "outside_window" => "時間外",
  "rate_limited" => "レート制限",
  "manual_override" => "手動確定",
  "ip_blocked" => "IP制限",
  "device_blocked" => "ブラウザ制限",
  "class_canceled" => "休講",
  "location_required" => "位置情報なし",
  "location_invalid" => "位置情報不正",
  "location_inaccurate" => "位置情報精度低",
  "location_outside" => "位置情報範囲外"
} %>
<% reason_labels = {
  "invalid" => "無効",
  "expired" => "期限切れ",
  "revoked" => "失効",
  "not_enrolled" => "未履修",
  "session_missing" => "セッション不明",
  "no_schedule" => "予定なし",
  "session_locked" => "確定済み",
  "wrong_date" => "日付不一致",
  "error" => "エラー",
  "early" => "開始前",
  "outside_window" => "時間外",
  "rate_limited" => "レート制限",
  "manual_override" => "手動確定",
  "ip_blocked" => "IP制限",
  "device_blocked" => "ブラウザ制限",
  "class_canceled" => "休講",
  "location_required" => "位置情報なし",
  "location_invalid" => "位置情報不正",
  "location_inaccurate" => "精度不足",
  "location_outside" => "校外"
} %>
<% status_badges = {
  "success" => "badge badge-success",
  "checkout" => "badge badge-info",
  "checkout_duplicate" => "badge badge-info",
  "duplicate" => "badge badge-info",
  "invalid" => "badge badge-error",
  "expired" => "badge badge-error",
  "revoked" => "badge badge-error",
  "not_enrolled" => "badge badge-error",
  "session_missing" => "badge badge-error",
  "no_schedule" => "badge badge-warning",
  "session_locked" => "badge badge-warning",
  "wrong_date" => "badge badge-error",
  "error" => "badge badge-error",
  "early" => "badge badge-warning",
  "outside_window" => "badge badge-error",
  "rate_limited" => "badge badge-warning",
  "manual_override" => "badge badge-info",
  "ip_blocked" => "badge badge-error",
  "device_blocked" => "badge badge-error",
  "class_canceled" => "badge badge-warning",
  "location_required" => "badge badge-error",
  "location_invalid" => "badge badge-error",
  "location_inaccurate" => "badge badge-warning",
  "location_outside" => "badge badge-error"
} %>
<% attendance_labels = {
  "present" => "出席",
  "late" => "遅刻",
  "absent" => "欠席",
  "excused" => "公欠",
  "early_leave" => "早退"
} %>
<% attendance_badges = {
  "present" => "badge badge-success",
  "late" => "badge badge-warning",
  "absent" => "badge badge-error",
  "excused" => "badge badge-info",
  "early_leave" => "badge badge-warning"
} %>

<div class="max-w-6xl mx-auto space-y-6">
  <%# ページヘッダー %>
  <div class="page-header">
    <div>
      <h1 class="page-title">QRスキャンログ</h1>
      <p class="page-subtitle">直近200件まで表示します。</p>
      <%= breadcrumb(["スキャンログ"]) %>
    </div>
  </div>

  <%= turbo_frame_tag "qr_scan_events_results", class: "drawer-panel relative", data: { controller: "drawer", drawer_open_value: true } do %>
  <%= render "shared/frame_loader" %>

  <%# フィルターカード %>
  <div class="card">
    <div class="card-header">
      <h2 class="font-semibold">絞り込み条件</h2>
    </div>
    <div class="card-body" data-controller="filter" data-filter-storage-key-value="scan-logs">
      <%= form_with url: scan_logs_path,
        method: :get,
        class: "grid grid-cols-1 md:grid-cols-4 gap-4 items-end",
        data: {
          controller: "request-filter",
          action: "change->request-filter#submit input->request-filter#submitDebounced"
        } do |f| %>
        <div>
          <%= f.label :class_id, "クラス", class: "block text-sm font-medium mb-2", style: "color: var(--color-text-primary);" %>
          <%= f.select :class_id,
            options_for_select(@classes.map { |klass| ["#{klass.name} (#{klass.room})", klass.id] }, @selected_class&.id),
            { include_blank: "すべて" },
            class: "input" %>
        </div>
        <div class="min-w-0">
          <%= f.label :date, "日付", class: "block text-sm font-medium mb-2", style: "color: var(--color-text-primary);" %>
          <%= f.date_field :date, value: @date, class: "input" %>
        </div>
        <div>
          <%= f.label :status, "結果", class: "block text-sm font-medium mb-2", style: "color: var(--color-text-primary);" %>
          <%= f.select :status,
            options_for_select(status_labels.map { |key, label| [label, key] }, @status),
            { include_blank: "すべて" },
            class: "input" %>
        </div>
        <div>
          <%= f.label :attendance_status, "出席判定", class: "block text-sm font-medium mb-2", style: "color: var(--color-text-primary);" %>
          <%= f.select :attendance_status,
            options_for_select(attendance_labels.map { |key, label| [label, key] }, @attendance_status),
            { include_blank: "すべて" },
            class: "input" %>
        </div>
        <div class="md:col-span-4 flex flex-col sm:flex-row gap-2">
          <%= f.submit "絞り込む", class: "btn btn-primary w-full sm:w-auto" %>
          <% if session[:qr_scan_events_last_filter].present? %>
            <%= link_to "前回条件",
              scan_logs_path(session[:qr_scan_events_last_filter]),
              class: "btn btn-secondary w-full sm:w-auto" %>
          <% end %>
          <%= link_to "CSV出力",
            scan_logs_path(format: :csv, class_id: @selected_class&.id, date: @date, status: @status, attendance_status: @attendance_status),
            class: "btn btn-secondary w-full sm:w-auto",
            data: { turbo: false } %>
        </div>
      <% end %>
    </div>
  </div>

  <%# 統計カード %>
  <% status_counts = @scan_events.group_by(&:status).transform_values(&:count) %>
  <% attendance_counts = @scan_events.group_by(&:attendance_status).transform_values(&:count) %>
  <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
    <div class="card">
      <div class="card-body py-3">
        <div class="text-xs text-body-muted">表示件数</div>
        <div class="text-lg font-semibold"><%= @scan_events.size %>件</div>
      </div>
    </div>
    <div class="card">
      <div class="card-body py-3">
        <div class="text-xs text-body-muted">結果内訳</div>
        <div class="text-sm">
          成功 <%= status_counts["success"].to_i %> / 退室 <%= status_counts["checkout"].to_i %> / エラー <%= status_counts["error"].to_i %>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-body py-3">
        <div class="text-xs text-body-muted">出席判定</div>
        <div class="text-sm">
          出席 <%= attendance_counts["present"].to_i %> / 遅刻 <%= attendance_counts["late"].to_i %> / 欠席 <%= attendance_counts["absent"].to_i %>
        </div>
      </div>
    </div>
  </div>

  <%# 検索バー %>
  <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3">
    <p class="text-xs text-body-muted">検索条件はブラウザに保存されます。</p>
    <div class="relative w-full sm:w-64">
      <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
        <svg class="h-4 w-4 text-body-muted" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="7" />
          <path d="M21 21l-4.3-4.3" stroke-linecap="round" stroke-linejoin="round" />
        </svg>
      </div>
      <input
        type="text"
        class="input"
        style="padding-left: 2.5rem;"
        placeholder="学生/クラス/ブラウザで検索"
        data-filter-target="input"
        data-action="input->filter#filter"
      />
    </div>
  </div>

  <%# データテーブル %>
  <div class="card">
    <div class="card-body p-0">
      <div class="table-container">
        <table class="w-full">
          <thead>
            <tr>
              <th>時刻</th>
              <th>クラス</th>
              <th>学生</th>
              <th>結果</th>
              <th>理由</th>
              <th>出席判定</th>
              <th>IP</th>
              <th>ブラウザ</th>
            </tr>
          </thead>
          <tbody>
            <% if @scan_events.any? %>
              <% @scan_events.each do |event| %>
                <tr data-filter-target="row">
                  <td class="px-4 py-3 whitespace-normal text-sm text-body-secondary">
                    <%= link_to qr_scan_event_path(event),
                      data: { turbo_frame: "qr_scan_event_detail" },
                      class: "block hover:underline",
                      style: "color: var(--color-primary);" do %>
                      <div><%= event.scanned_at&.strftime("%Y-%m-%d") %></div>
                      <div class="text-xs text-body-muted"><%= event.scanned_at&.strftime("%H:%M:%S") %></div>
                    <% end %>
                  </td>
                  <td class="px-4 py-3 whitespace-normal text-sm">
                    <div><%= event.school_class&.name || "-" %></div>
                    <% if event.qr_session_id %>
                      <div class="text-xs text-body-muted">session #<%= event.qr_session_id %></div>
                    <% end %>
                  </td>
                  <td class="px-4 py-3 whitespace-normal text-sm">
                    <div><%= event.user&.name || "-" %></div>
                    <div class="text-xs text-body-muted"><%= event.user&.student_id || "-" %></div>
                  </td>
                  <td class="px-4 py-3 whitespace-normal">
                    <span class="<%= status_badges[event.status] || "badge" %>">
                      <%= status_labels[event.status] || event.status %>
                    </span>
                  </td>
                  <td class="px-4 py-3 whitespace-normal text-sm text-body-secondary">
                    <%= reason_labels[event.status] || "-" %>
                  </td>
                  <td class="px-4 py-3 whitespace-normal">
                    <% if event.attendance_status.present? %>
                      <span class="<%= attendance_badges[event.attendance_status] || "badge" %>">
                        <%= attendance_labels[event.attendance_status] || event.attendance_status %>
                      </span>
                    <% else %>
                      <span class="text-xs text-body-muted">-</span>
                    <% end %>
                  </td>
                  <td class="px-4 py-3 whitespace-normal text-sm text-body-secondary"><%= event.ip || "-" %></td>
                  <td class="px-4 py-3 whitespace-normal text-sm text-body-secondary">
                    <%= truncate(event.user_agent.to_s, length: 28) %>
                  </td>
                </tr>
              <% end %>
            <% else %>
              <tr>
                <td colspan="8" class="px-4 py-8 text-center">
                  <div class="empty-state" style="padding: 0;">
                    <div class="empty-state-title">該当なし</div>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <% end %>
</div>

<%= turbo_frame_tag "qr_scan_event_detail",
  class: "drawer-panel drawer-sheet hidden",
  data: { controller: "drawer", drawer_open_value: false } do %>
  <div class="hidden"></div>
<% end %>
