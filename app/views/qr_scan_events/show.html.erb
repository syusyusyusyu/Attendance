<% status_labels = {
  "success" => "成功",
  "checkout" => "退室",
  "checkout_duplicate" => "退室済み",
  "duplicate" => "重複",
  "invalid" => "無効",
  "expired" => "期限切れ",
  "revoked" => "失効",
  "not_enrolled" => "未履修",
  "session_missing" => "セッション不明",
  "no_schedule" => "予定なし",
  "session_locked" => "確定済み",
  "wrong_date" => "日付不一致",
  "error" => "エラー",
  "early" => "開始前",
  "outside_window" => "時間外",
  "rate_limited" => "レート制限",
  "manual_override" => "手動確定",
  "ip_blocked" => "IP制限",
  "device_blocked" => "ブラウザ制限",
  "class_canceled" => "休講",
  "location_required" => "位置情報なし",
  "location_invalid" => "位置情報不正",
  "location_inaccurate" => "精度不足",
  "location_outside" => "校外"
} %>

<% attendance_labels = {
  "present" => "出席",
  "late" => "遅刻",
  "absent" => "欠席",
  "excused" => "公欠",
  "early_leave" => "早退"
} %>

<%= turbo_frame_tag "qr_scan_event_detail",
  class: "drawer-panel drawer-sheet",
  data: { controller: "drawer", drawer_open_value: true } do %>
  <div class="card p-6 space-y-4">
    <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-2">
      <div>
        <h2 class="text-xl font-semibold text-gray-900">スキャン詳細</h2>
        <p class="text-sm text-gray-500 mt-1">監査: いつ / 誰が / 結果 / 判定</p>
      </div>
      <button type="button" class="text-sm text-gray-500 hover:text-gray-700" data-action="drawer#close">
        閉じる
      </button>
    </div>

    <dl class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
      <div class="rounded-lg border border-gray-200 p-4">
        <dt class="text-xs text-gray-500">スキャン日時</dt>
        <dd class="mt-1 font-medium text-gray-900"><%= l(@event.scanned_at, format: :short) %></dd>
      </div>

      <div class="rounded-lg border border-gray-200 p-4">
        <dt class="text-xs text-gray-500">クラス</dt>
        <dd class="mt-1 font-medium text-gray-900"><%= @event.school_class&.name || "-" %></dd>
      </div>

      <div class="rounded-lg border border-gray-200 p-4">
        <dt class="text-xs text-gray-500">学生</dt>
        <dd class="mt-1 font-medium text-gray-900">
          <%= @event.user&.name || "-" %>
          <span class="text-xs text-gray-500 ml-2"><%= @event.user&.student_id || "-" %></span>
        </dd>
      </div>

      <div class="rounded-lg border border-gray-200 p-4">
        <dt class="text-xs text-gray-500">結果</dt>
        <dd class="mt-1 font-medium text-gray-900"><%= status_labels[@event.status] || @event.status %></dd>
      </div>

      <div class="rounded-lg border border-gray-200 p-4">
        <dt class="text-xs text-gray-500">出席判定</dt>
        <dd class="mt-1 font-medium text-gray-900">
          <%= @event.attendance_status.present? ? (attendance_labels[@event.attendance_status] || @event.attendance_status) : "-" %>
        </dd>
      </div>

      <div class="rounded-lg border border-gray-200 p-4">
        <dt class="text-xs text-gray-500">QRセッション</dt>
        <dd class="mt-1 font-medium text-gray-900"><%= @event.qr_session_id || "-" %></dd>
      </div>

      <div class="rounded-lg border border-gray-200 p-4">
        <dt class="text-xs text-gray-500">IP</dt>
        <dd class="mt-1 font-medium text-gray-900"><%= @event.ip.presence || "-" %></dd>
      </div>

      <div class="rounded-lg border border-gray-200 p-4 sm:col-span-2">
        <dt class="text-xs text-gray-500">ブラウザ</dt>
        <dd class="mt-1 text-gray-900 break-words"><%= @event.user_agent.presence || "-" %></dd>
      </div>
    </dl>
  </div>
<% end %>
