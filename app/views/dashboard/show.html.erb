<%# AdminKit風ダッシュボード: KPIカード、Bento配置、クイック導線 %>
<% greeting = case Time.current.hour
  when 5..10
    "おはようございます"
  when 11..17
    "こんにちは"
  else
    "こんばんは"
  end %>

<% role_label = if @user.admin?
  "管理者"
elsif @user.teacher?
  "教員"
else
  "学生"
end %>

<div class="space-y-6">
  <%# ページヘッダー %>
  <div class="page-header">
    <div>
      <h1 class="page-title">ダッシュボード</h1>
      <p class="page-subtitle"><%= greeting %>、<%= @user.name %>さん（<%= role_label %>）</p>
      <%= breadcrumb() %>
    </div>
    <div class="text-sm text-body-secondary">
      今日: <%= Time.zone.today.strftime("%Y/%m/%d") %>
    </div>
  </div>

  <%# 初回ガイド（学生のみ） %>
  <% if @user.student? && @show_onboarding %>
    <div class="card border-[var(--color-primary-light)] bg-primary-light">
      <div class="card-body">
        <h2 class="text-lg font-semibold mb-3">初回ガイド</h2>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
          <div class="flex items-center gap-3">
            <span class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold text-white bg-primary">1</span>
            <span>QRを開く</span>
          </div>
          <div class="flex items-center gap-3">
            <span class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold text-white bg-primary">2</span>
            <span>スキャンで出席</span>
          </div>
          <div class="flex items-center gap-3">
            <span class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold text-white bg-primary">3</span>
            <span>再スキャンで退室</span>
          </div>
        </div>
        <div class="mt-3 text-sm text-body-secondary">困ったら: 手入力 / 出席申請</div>
      </div>
    </div>
  <% end %>

  <%# KPIカード %>
  <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
    <% if @user.staff? %>
      <%# 教員/管理者KPI %>
      <div class="kpi-card">
        <div class="kpi-card-icon success">
          <svg class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 11-5.93-9.14" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M22 4L12 14.01l-3-3" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <div class="kpi-card-title">出席率</div>
        <div class="kpi-card-value"><%= @staff_attendance_rate %>%</div>
        <% if @staff_attendance_diff %>
          <div class="kpi-card-diff <%= @staff_attendance_diff >= 0 ? 'positive' : 'negative' %>">
            <%= @staff_attendance_diff >= 0 ? '+' : '' %><%= @staff_attendance_diff %>% 前日比
          </div>
        <% end %>
      </div>
      <div class="kpi-card">
        <div class="kpi-card-icon warning">
          <svg class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 3h6a2 2 0 012 2v1H7V5a2 2 0 012-2z"/>
            <rect x="5" y="6" width="14" height="15" rx="2" ry="2"/>
            <path d="M9 14l2 2 4-4" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <div class="kpi-card-title">承認待ち</div>
        <div class="kpi-card-value"><%= @pending_requests_count %>件</div>
        <div class="kpi-card-diff">
          今日 <%= @pending_requests_today %>件
        </div>
      </div>
      <div class="kpi-card">
        <div class="kpi-card-icon error">
          <svg class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z" stroke-linecap="round" stroke-linejoin="round"/>
            <line x1="12" y1="9" x2="12" y2="13"/>
            <line x1="12" y1="17" x2="12.01" y2="17"/>
          </svg>
        </div>
        <div class="kpi-card-title">注意学生</div>
        <div class="kpi-card-value"><%= @attention_students.size %>名</div>
        <div class="kpi-card-diff">
          直近30日
        </div>
      </div>
    <% else %>
      <%# 学生KPI %>
      <div class="kpi-card">
        <div class="kpi-card-icon success">
          <svg class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 11-5.93-9.14" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M22 4L12 14.01l-3-3" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <div class="kpi-card-title">出席率</div>
        <div class="kpi-card-value"><%= @student_attendance_rate %>%</div>
        <% if @student_attendance_diff %>
          <div class="kpi-card-diff <%= @student_attendance_diff >= 0 ? 'positive' : 'negative' %>">
            <%= @student_attendance_diff >= 0 ? '+' : '' %><%= @student_attendance_diff %>% 前月比
          </div>
        <% end %>
      </div>
      <div class="kpi-card">
        <div class="kpi-card-icon">
          <svg class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <path d="M12 6v6l4 2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <div class="kpi-card-title">申請待ち</div>
        <div class="kpi-card-value"><%= @pending_requests_count %>件</div>
        <div class="kpi-card-diff">
          今日 <%= @student_pending_today %>件
        </div>
      </div>
      <div class="kpi-card">
        <div class="kpi-card-icon warning">
          <svg class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z" stroke-linecap="round" stroke-linejoin="round"/>
            <line x1="12" y1="9" x2="12" y2="13"/>
            <line x1="12" y1="17" x2="12.01" y2="17"/>
          </svg>
        </div>
        <div class="kpi-card-title">注意</div>
        <div class="kpi-card-value"><%= @student_warnings.size %>件</div>
        <div class="kpi-card-diff">
          直近30日
        </div>
      </div>
    <% end %>
  </div>

  <%# 30日出席推移（教員/管理者） %>
  <% if @user.staff? %>
    <div class="card">
      <div class="card-header">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold">30日出席推移</h2>
          <% if @staff_daily_rates.present? %>
            <% average_rate = (@staff_daily_rates.sum { |row| row[:rate] }.to_f / @staff_daily_rates.size).round %>
            <span class="text-sm text-body-secondary">平均 <%= average_rate %>%</span>
          <% end %>
        </div>
      </div>
      <div class="card-body">
        <% if @staff_daily_rates.present? %>
          <div class="chart-grid" role="img" aria-label="30日出席推移">
            <% @staff_daily_rates.each do |row| %>
              <div class="chart-bar" title="<%= row[:date].strftime('%m/%d') %> <%= row[:rate] %>%">
                <span style="height: <%= row[:rate] %>%"></span>
              </div>
            <% end %>
          </div>
          <div class="chart-labels">
            <span><%= 29.days.ago.strftime("%m/%d") %></span>
            <span>今日</span>
          </div>
        <% else %>
          <div class="empty-state">
            <div class="empty-state-title">出席データがありません</div>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <%# クイック導線カード %>
  <% if @user.staff? %>
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
      <%= link_to school_classes_path, class: "card group hover:shadow-md transition-all" do %>
        <div class="card-body text-center">
          <div class="w-12 h-12 mx-auto rounded-full flex items-center justify-center mb-3 bg-info-light">
            <svg class="h-6 w-6 text-info" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="8" cy="8" r="3"/>
              <circle cx="17" cy="8" r="3"/>
              <path d="M2 20a6 6 0 0112 0" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M13 20a6 6 0 019 0" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <h3 class="font-semibold">クラス管理</h3>
          <p class="text-sm mt-1 text-body-secondary">クラス/名簿</p>
        </div>
      <% end %>

      <%= link_to attendance_path, class: "card group hover:shadow-md transition-all" do %>
        <div class="card-body text-center">
          <div class="w-12 h-12 mx-auto rounded-full flex items-center justify-center mb-3 bg-error-light">
            <svg class="h-6 w-6 text-error" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="9"/>
              <path d="M12 7v5l3 3" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <h3 class="font-semibold">出席確認</h3>
          <p class="text-sm mt-1 text-body-secondary">出席一覧</p>
        </div>
      <% end %>

      <%= link_to generate_qr_path, class: "card group hover:shadow-md transition-all" do %>
        <div class="card-body text-center">
          <div class="w-12 h-12 mx-auto rounded-full flex items-center justify-center mb-3 bg-success-light">
            <svg class="h-6 w-6 text-success" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="6" height="6"/>
              <rect x="15" y="3" width="6" height="6"/>
              <rect x="3" y="15" width="6" height="6"/>
              <path d="M15 15h6v6h-6z"/>
              <path d="M11 11h2v2h-2z"/>
            </svg>
          </div>
          <h3 class="font-semibold">QRコード発行</h3>
          <p class="text-sm mt-1 text-body-secondary">授業QR</p>
        </div>
      <% end %>

      <%= link_to reports_path, class: "card group hover:shadow-md transition-all" do %>
        <div class="card-body text-center">
          <div class="w-12 h-12 mx-auto rounded-full flex items-center justify-center mb-3 bg-warning-light">
            <svg class="h-6 w-6 text-warning" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 3v18h18" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M7 14l3-3 3 3 5-6" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <h3 class="font-semibold">レポート</h3>
          <p class="text-sm mt-1 text-body-secondary">集計</p>
        </div>
      <% end %>
    </div>
  <% else %>
    <%# 学生クイック導線 %>
    <div class="grid grid-cols-3 gap-4">
      <%= link_to scan_path, class: "card group hover:shadow-md transition-all" do %>
        <div class="card-body text-center">
          <div class="w-12 h-12 mx-auto rounded-full flex items-center justify-center mb-3 bg-success-light">
            <svg class="h-6 w-6 text-success" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="6" height="6"/>
              <rect x="15" y="3" width="6" height="6"/>
              <rect x="3" y="15" width="6" height="6"/>
              <path d="M15 15h6v6h-6z"/>
              <path d="M11 11h2v2h-2z"/>
            </svg>
          </div>
          <h3 class="font-semibold">スキャン</h3>
          <p class="text-sm mt-1 text-body-secondary">出席</p>
        </div>
      <% end %>

      <%= link_to history_path, class: "card group hover:shadow-md transition-all" do %>
        <div class="card-body text-center">
          <div class="w-12 h-12 mx-auto rounded-full flex items-center justify-center mb-3 bg-info-light">
            <svg class="h-6 w-6 text-info" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="9"/>
              <path d="M12 7v5l3 3" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <h3 class="font-semibold">出席履歴</h3>
          <p class="text-sm mt-1 text-body-secondary">履歴</p>
        </div>
      <% end %>

      <%= link_to attendance_requests_path, class: "card group hover:shadow-md transition-all" do %>
        <div class="card-body text-center">
          <div class="w-12 h-12 mx-auto rounded-full flex items-center justify-center mb-3 bg-error-light">
            <svg class="h-6 w-6 text-error" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 3v18" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M5 8h14" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M5 16h14" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <h3 class="font-semibold">出席申請</h3>
          <p class="text-sm mt-1 text-body-secondary">欠席/遅刻</p>
        </div>
      <% end %>
    </div>
  <% end %>

  <% if @user.staff? %>
    <%# 今日の授業（教員） %>
    <div class="card">
      <div class="card-header">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold">今日の授業</h2>
          <span class="text-sm text-body-secondary"><%= Time.zone.today.strftime("%Y/%m/%d") %></span>
        </div>
      </div>
      <div class="card-body">
        <% if @today_classes.any? %>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            <% @today_classes.each do |klass| %>
              <% stats = @today_stats[klass.id] %>
              <div class="p-4 border-themed rounded-theme-lg">
                <div class="flex items-start justify-between gap-3">
                  <div>
                    <div class="font-medium"><%= klass.name %></div>
                    <div class="text-xs mt-1 text-body-secondary"><%= klass.room %> / <%= klass.schedule_label %></div>
                  </div>
                  <span class="text-xs px-2 py-1 rounded-full bg-primary-light text-primary"><%= stats[:total] %>名</span>
                </div>
                <% if @today_sessions[klass.id] %>
                  <div class="mt-2">
                    <%= render "shared/session_status_badges", session: @today_sessions[klass.id] %>
                  </div>
                <% end %>
                <div class="mt-3">
                  <div class="flex items-center justify-between text-xs mb-1 text-body-secondary">
                    <span>出席率</span>
                    <span class="font-medium"><%= stats[:rate] %>%</span>
                  </div>
                  <div class="h-2 rounded-full bg-background">
                    <div class="h-2 rounded-full progress-fill-success" style="width: <%= stats[:rate] %>%"></div>
                  </div>
                  <div class="mt-2 text-xs text-body-secondary">
                    出席 <%= stats[:present] %> / 欠席 <%= stats[:absent] %> / 未入力 <%= stats[:missing] %>
                  </div>
                </div>
                <div class="mt-3 flex gap-2">
                  <%= link_to "QR発行", generate_qr_path(class_id: klass.id), class: "btn btn-primary text-xs flex-1" %>
                  <%= link_to "出席確認", attendance_path(class_id: klass.id, date: Time.zone.today), class: "btn btn-secondary text-xs flex-1" %>
                </div>
              </div>
            <% end %>
          </div>
        <% else %>
          <div class="empty-state">
            <div class="empty-state-title">今日の授業はありません</div>
          </div>
        <% end %>
      </div>
    </div>

    <%# Bento配置: 注意学生/承認待ち/通知 %>
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <div class="card">
        <div class="card-header">
          <div class="flex items-center justify-between">
            <h2 class="font-semibold">注意学生</h2>
            <%= link_to "ログ", attendance_logs_path, class: "text-sm", style: "color: var(--color-primary);" %>
          </div>
        </div>
        <div class="card-body">
          <% if @attention_students.any? %>
            <div class="space-y-3">
              <% @attention_students.each do |row| %>
                <div class="flex items-center justify-between p-3 border-themed rounded-theme-md">
                  <div>
                    <div class="text-sm font-medium"><%= row[:student].name %></div>
                    <div class="text-xs text-body-muted"><%= row[:student].student_id %></div>
                  </div>
                  <span class="badge badge-error">欠席/早退 <%= row[:absences] %></span>
                </div>
              <% end %>
            </div>
          <% else %>
            <div class="text-sm text-center py-4 text-body-secondary">要注意の学生はいません。</div>
          <% end %>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="flex items-center justify-between">
            <h2 class="font-semibold">承認待ち</h2>
            <%= link_to "申請一覧", attendance_requests_path(status: "pending"), class: "text-sm", style: "color: var(--color-primary);" %>
          </div>
        </div>
        <div class="card-body">
          <% if @pending_requests.any? %>
            <div class="space-y-3">
              <% @pending_requests.each do |request| %>
                <div class="p-3 border-themed rounded-theme-md">
                  <div class="text-sm font-medium"><%= request.user.name %> / <%= request.school_class.name %></div>
                  <div class="flex items-center gap-2 mt-1">
                    <span class="text-xs text-body-secondary"><%= request.date.strftime("%Y-%m-%d") %></span>
                    <span class="badge badge-warning"><%= { "absent" => "欠席", "late" => "遅刻", "excused" => "公欠" }[request.request_type] || request.request_type %></span>
                  </div>
                </div>
              <% end %>
            </div>
          <% else %>
            <div class="text-sm text-center py-4 text-body-secondary">申請待ちはありません。</div>
          <% end %>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="flex items-center justify-between">
            <h2 class="font-semibold">通知</h2>
            <%= link_to "通知一覧", notifications_path, class: "text-sm", style: "color: var(--color-primary);" %>
          </div>
        </div>
        <div class="card-body">
          <% if @recent_notifications.any? %>
            <div class="space-y-3">
              <% @recent_notifications.each do |notification| %>
                <div class="p-3 border-themed rounded-theme-md">
                  <div class="text-sm font-medium"><%= notification.title %></div>
                  <div class="text-xs mt-1 text-body-secondary"><%= notification.created_at.strftime("%Y-%m-%d %H:%M") %></div>
                </div>
              <% end %>
            </div>
          <% else %>
            <div class="text-sm text-center py-4 text-body-secondary">通知はありません。</div>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>

  <% if @user.student? %>
    <%# 学生: 出席傾向と注意 %>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <div class="card">
        <div class="card-header">
          <h2 class="font-semibold">出席傾向(30日)</h2>
        </div>
        <div class="card-body">
          <% if @student_summary.any? %>
            <div class="space-y-4">
              <% @student_summary.each do |row| %>
                <div class="p-3 border-themed rounded-theme-md">
                  <div class="flex items-center justify-between mb-2">
                    <div class="font-medium"><%= row[:klass].name %></div>
                    <span class="text-sm font-semibold text-primary"><%= row[:rate] %>%</span>
                  </div>
                  <div class="h-2 rounded-full bg-background">
                    <div class="h-2 rounded-full progress-fill-success" style="width: <%= row[:rate] %>%"></div>
                  </div>
                  <div class="flex gap-3 mt-2 text-xs text-body-secondary">
                    <span>出席 <%= row[:present] %></span>
                    <span>欠席 <%= row[:absent] %></span>
                    <span>遅刻 <%= row[:late] %></span>
                  </div>
                </div>
              <% end %>
            </div>
          <% else %>
            <div class="empty-state">
              <div class="empty-state-title">履修中のクラスがありません</div>
            </div>
          <% end %>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="flex items-center justify-between">
            <h2 class="font-semibold">注意</h2>
            <%= link_to "通知一覧", notifications_path, class: "text-sm", style: "color: var(--color-primary);" %>
          </div>
        </div>
        <div class="card-body">
          <% if @student_warnings.any? %>
            <div class="space-y-3">
              <% @student_warnings.each do |row| %>
                <div class="p-3 bg-warning-light border border-[var(--color-warning)] rounded-theme-md">
                  <div class="font-medium"><%= row[:klass].name %></div>
                  <div class="text-sm mt-1 text-warning-dark">欠席/早退 <%= row[:absent] + row[:early_leave] %> 回 / 出席率 <%= row[:rate] %>%</div>
                </div>
              <% end %>
            </div>
          <% else %>
            <div class="text-sm text-center py-4 text-body-secondary">注意が必要なクラスはありません。</div>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>

  <%# クラス一覧 %>
  <div class="card">
    <div class="card-header">
      <h2 class="font-semibold"><%= @user.staff? ? (@user.admin? ? "管理クラス" : "担当クラス") : "履修クラス" %></h2>
    </div>
    <% if @classes.any? %>
      <div class="divide-y divide-themed">
        <% @classes.each do |klass| %>
          <div class="p-4 hover:bg-[var(--color-surface-hover)] transition-colors">
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4">
              <div>
                <h3 class="font-medium"><%= klass.name %></h3>
                <p class="text-sm mt-1 text-body-secondary">
                  <%= [klass.schedule_label, "教室: #{klass.room}"].compact.join(" | ") %>
                </p>
                <% if @today_sessions[klass.id] %>
                  <div class="mt-2">
                    <%= render "shared/session_status_badges", session: @today_sessions[klass.id] %>
                  </div>
                <% end %>
              </div>
              <% if @user.staff? %>
                <%= link_to "出席確認", attendance_path(class_id: klass.id), class: "btn btn-secondary text-sm w-full sm:w-auto" %>
              <% else %>
                <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
                  <%= link_to "QR", scan_path, class: "btn btn-primary text-sm w-full sm:w-auto" %>
                  <%= link_to "履歴", history_path, class: "btn btn-secondary text-sm w-full sm:w-auto" %>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <div class="card-body">
        <div class="empty-state">
          <div class="empty-state-title"><%= @user.staff? ? (@user.admin? ? "管理できるクラスがありません" : "担当クラスがありません") : "履修中のクラスがありません" %></div>
        </div>
      </div>
    <% end %>
  </div>
</div>
