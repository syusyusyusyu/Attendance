<%# AdminKit風管理者ダッシュボード: KPIカード、テーブル %>
<% role_labels = { "student" => "学生", "teacher" => "教員", "admin" => "管理者" } %>
<% total_users = @users.size %>

<div class="max-w-6xl mx-auto space-y-6">
  <%# ページヘッダー %>
  <div class="page-header">
    <div>
      <h1 class="page-title">管理者ダッシュボード</h1>
      <p class="page-subtitle">システム全体の状況を確認できます</p>
      <%= breadcrumb(["管理"]) %>
    </div>
    <div class="flex flex-wrap gap-2">
      <%= link_to "ユーザー管理", admin_users_path, class: "btn btn-secondary text-sm" %>
      <%= link_to "ロール/権限", admin_roles_path, class: "btn btn-secondary text-sm" %>

      <%= link_to "監査ログ", attendance_logs_path, class: "btn btn-secondary text-sm" %>
    </div>
  </div>

  <div class="not-implemented-banner">
    <svg class="not-implemented-banner-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20z"/>
      <path d="M12 8v4l3 3"/>
    </svg>
    <span class="not-implemented-banner-text">出席修正/確定/解除の最終承認は管理者が担います。</span>
  </div>

  <%# KPIカード %>
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <%# 総ユーザー数 %>
    <div class="kpi-card">
      <div class="kpi-card-icon">
        <svg class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2" stroke-linecap="round" stroke-linejoin="round"/>
          <circle cx="9" cy="7" r="4" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
      <div class="kpi-card-title">総ユーザー数</div>
      <div class="kpi-card-value"><%= total_users %></div>
      <div class="kpi-card-diff text-body-secondary">
        学生 <%= @role_counts.fetch("student", 0) %> / 教員 <%= @role_counts.fetch("teacher", 0) %> / 管理者 <%= @role_counts.fetch("admin", 0) %>
      </div>
    </div>

    <%# 未処理の出席申請 %>
    <div class="kpi-card">
      <div class="kpi-card-icon warning">
        <svg class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 3h6a2 2 0 012 2v1H7V5a2 2 0 012-2z"/>
          <rect x="5" y="6" width="14" height="15" rx="2" ry="2"/>
          <path d="M9 14l2 2 4-4" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
      <div class="kpi-card-title">未処理の出席申請</div>
      <div class="kpi-card-value"><%= @pending_requests.size %></div>
      <div class="kpi-card-diff text-body-secondary">直近10件を下部に表示</div>
    </div>

    <%# 直近7日の監査集計 %>
    <div class="kpi-card">
      <div class="kpi-card-icon success">
        <svg class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 3v18h18" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M7 14l3-3 3 3 5-6" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
      <div class="kpi-card-title">直近7日の監査集計</div>
      <div class="space-y-1 mt-2">
        <div class="text-sm">変更ログ: <span class="font-semibold"><%= @change_source_counts.values.sum %></span> 件</div>
        <div class="text-sm">スキャンログ: <span class="font-semibold"><%= @scan_status_counts.values.sum %></span> 件</div>
      </div>
    </div>
  </div>

  <%# 申請テーブル %>
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <%# 未処理の出席申請 %>
    <div class="card">
      <div class="card-header">
        <h2 class="text-lg font-semibold">未処理の出席申請</h2>
      </div>
      <div class="table-container">
        <table class="w-full">
          <thead>
            <tr>
              <th>日付</th>
              <th>クラス</th>
              <th>学生</th>
              <th>種別</th>
            </tr>
          </thead>
          <tbody>
            <% if @pending_requests.any? %>
              <% @pending_requests.each do |request| %>
                <tr>
                  <td class="px-4 py-3 text-sm text-body-secondary"><%= request.date.strftime("%Y-%m-%d") %></td>
                  <td class="px-4 py-3 text-sm"><%= request.school_class.name %></td>
                  <td class="px-4 py-3 text-sm">
                    <div><%= request.user.name %></div>
                    <div class="text-xs text-body-muted"><%= request.user.student_id %></div>
                  </td>
                  <td class="px-4 py-3 text-sm">
                    <span class="badge badge-warning"><%= request.request_type %></span>
                  </td>
                </tr>
              <% end %>
            <% else %>
              <tr>
                <td colspan="4" class="px-4 py-8 text-center">
                  <div class="empty-state">
                    <div class="empty-state-title">該当なし</div>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>

  </div>

  <%# ログテーブル %>
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <%# 最近の出席変更ログ %>
    <div class="card">
      <div class="card-header">
        <h2 class="text-lg font-semibold">最近の出席変更ログ</h2>
      </div>
      <div class="table-container">
        <table class="w-full">
          <thead>
            <tr>
              <th>日時</th>
              <th>学生</th>
              <th>変更</th>
              <th>理由</th>
            </tr>
          </thead>
          <tbody>
            <% if @recent_changes.any? %>
              <% @recent_changes.each do |change| %>
                <tr>
                  <td class="px-4 py-3 text-sm text-body-secondary"><%= change.changed_at&.strftime("%m/%d %H:%M") %></td>
                  <td class="px-4 py-3 text-sm"><%= change.user&.name || "-" %></td>
                  <td class="px-4 py-3 text-sm"><%= "#{change.previous_status || '-'} → #{change.new_status}" %></td>
                  <td class="px-4 py-3 text-sm text-body-secondary"><%= change.reason.presence || "-" %></td>
                </tr>
              <% end %>
            <% else %>
              <tr>
                <td colspan="4" class="px-4 py-8 text-center">
                  <div class="empty-state">
                    <div class="empty-state-title">該当なし</div>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>

    <%# 最近のQRスキャン %>
    <div class="card">
      <div class="card-header">
        <h2 class="text-lg font-semibold">最近のQRスキャン</h2>
      </div>
      <div class="table-container">
        <table class="w-full">
          <thead>
            <tr>
              <th>時刻</th>
              <th>学生</th>
              <th>結果</th>
              <th>クラス</th>
            </tr>
          </thead>
          <tbody>
            <% if @recent_scans.any? %>
              <% @recent_scans.each do |scan| %>
                <tr>
                  <td class="px-4 py-3 text-sm text-body-secondary"><%= scan.scanned_at&.strftime("%m/%d %H:%M") %></td>
                  <td class="px-4 py-3 text-sm"><%= scan.user&.name || "-" %></td>
                  <td class="px-4 py-3 text-sm">
                    <%
                      status_class = case scan.status
                        when "present" then "badge-success"
                        when "late" then "badge-warning"
                        when "failed" then "badge-error"
                        else "badge-neutral"
                      end
                    %>
                    <span class="badge <%= status_class %>"><%= scan.status %></span>
                  </td>
                  <td class="px-4 py-3 text-sm text-body-secondary"><%= scan.school_class&.name || "-" %></td>
                </tr>
              <% end %>
            <% else %>
              <tr>
                <td colspan="4" class="px-4 py-8 text-center">
                  <div class="empty-state">
                    <div class="empty-state-title">該当なし</div>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
