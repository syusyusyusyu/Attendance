<% role_labels = { "student" => "学生", "teacher" => "教員", "admin" => "管理者" } %>
<% total_users = @users.size %>

<div class="max-w-6xl mx-auto space-y-6">
  <div class="card p-6">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
      <div>
        <h1 class="text-2xl font-semibold text-gray-900">管理者ダッシュボード</h1>
      </div>
      <div class="flex flex-wrap gap-2">
        <%= link_to "ユーザー管理", admin_users_path, class: "btn btn-secondary text-sm" %>
        <%= link_to "ロール/権限", admin_roles_path, class: "btn btn-secondary text-sm" %>
        <%= link_to "操作申請", admin_operation_requests_path, class: "btn btn-secondary text-sm" %>
        <%= link_to "監査ログ", attendance_logs_path, class: "btn btn-secondary text-sm" %>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <div class="card p-4">
      <div class="text-xs text-gray-500">総ユーザー数</div>
      <div class="text-2xl font-semibold text-gray-900 mt-1"><%= total_users %></div>
      <div class="text-xs text-gray-500 mt-2">
        学生 <%= @role_counts.fetch("student", 0) %> / 教員 <%= @role_counts.fetch("teacher", 0) %> / 管理者 <%= @role_counts.fetch("admin", 0) %>
      </div>
    </div>
    <div class="card p-4">
      <div class="text-xs text-gray-500">未処理の出席申請</div>
      <div class="text-2xl font-semibold text-gray-900 mt-1"><%= @pending_requests.size %></div>
      <div class="text-xs text-gray-500 mt-2">直近10件を下部に表示</div>
    </div>
    <div class="card p-4">
      <div class="text-xs text-gray-500">直近7日の監査集計</div>
      <div class="mt-2 space-y-1 text-sm text-gray-700">
        <div>変更ログ: <%= @change_source_counts.values.sum %> 件</div>
        <div>スキャンログ: <%= @scan_status_counts.values.sum %> 件</div>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <div class="card p-6">
      <h2 class="text-lg font-medium text-gray-900 mb-4">未処理の出席申請</h2>
      <div class="table-container">
        <table class="min-w-full divide-y divide-gray-200 text-sm">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">日付</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">クラス</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">学生</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">種別</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <% if @pending_requests.any? %>
              <% @pending_requests.each do |request| %>
                <tr>
                  <td class="px-4 py-2 text-sm text-gray-500"><%= request.date.strftime("%Y-%m-%d") %></td>
                  <td class="px-4 py-2 text-sm text-gray-700"><%= request.school_class.name %></td>
                  <td class="px-4 py-2 text-sm text-gray-700">
                    <div><%= request.user.name %></div>
                    <div class="text-xs text-gray-400"><%= request.user.student_id %></div>
                  </td>
                  <td class="px-4 py-2 text-sm text-gray-700"><%= request.request_type %></td>
                </tr>
              <% end %>
            <% else %>
              <tr>
                <td colspan="4" class="px-4 py-6 text-center text-sm text-gray-500">申請がありません。</td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>

    <div class="card p-6">
      <h2 class="text-lg font-medium text-gray-900 mb-4">未処理の操作申請</h2>
      <div class="table-container">
        <table class="min-w-full divide-y divide-gray-200 text-sm">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">申請者</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">クラス</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">種別</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">申請日時</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <% if @pending_operations.any? %>
              <% @pending_operations.each do |request| %>
                <tr>
                  <td class="px-4 py-2 text-sm text-gray-700"><%= request.user&.name || "-" %></td>
                  <td class="px-4 py-2 text-sm text-gray-700"><%= request.school_class&.name || "-" %></td>
                  <td class="px-4 py-2 text-sm text-gray-700"><%= request.kind %></td>
                  <td class="px-4 py-2 text-sm text-gray-500"><%= request.created_at.strftime("%Y-%m-%d %H:%M") %></td>
                </tr>
              <% end %>
            <% else %>
              <tr>
                <td colspan="4" class="px-4 py-6 text-center text-sm text-gray-500">申請がありません。</td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <div class="card p-6">
      <h2 class="text-lg font-medium text-gray-900 mb-4">最近の出席変更ログ</h2>
      <div class="table-container">
        <table class="min-w-full divide-y divide-gray-200 text-sm">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">日時</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">学生</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">変更</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">理由</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <% if @recent_changes.any? %>
              <% @recent_changes.each do |change| %>
                <tr>
                  <td class="px-4 py-2 text-sm text-gray-500"><%= change.changed_at&.strftime("%m/%d %H:%M") %></td>
                  <td class="px-4 py-2 text-sm text-gray-700"><%= change.user&.name || "-" %></td>
                  <td class="px-4 py-2 text-sm text-gray-700"><%= "#{change.previous_status || '-'} → #{change.new_status}" %></td>
                  <td class="px-4 py-2 text-sm text-gray-500"><%= change.reason.presence || "-" %></td>
                </tr>
              <% end %>
            <% else %>
              <tr>
                <td colspan="4" class="px-4 py-6 text-center text-sm text-gray-500">ログがありません。</td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>

    <div class="card p-6">
      <h2 class="text-lg font-medium text-gray-900 mb-4">最近のQRスキャン</h2>
      <div class="table-container">
        <table class="min-w-full divide-y divide-gray-200 text-sm">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">時刻</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">学生</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">結果</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">クラス</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <% if @recent_scans.any? %>
              <% @recent_scans.each do |scan| %>
                <tr>
                  <td class="px-4 py-2 text-sm text-gray-500"><%= scan.scanned_at&.strftime("%m/%d %H:%M") %></td>
                  <td class="px-4 py-2 text-sm text-gray-700"><%= scan.user&.name || "-" %></td>
                  <td class="px-4 py-2 text-sm text-gray-700"><%= scan.status %></td>
                  <td class="px-4 py-2 text-sm text-gray-500"><%= scan.school_class&.name || "-" %></td>
                </tr>
              <% end %>
            <% else %>
              <tr>
                <td colspan="4" class="px-4 py-6 text-center text-sm text-gray-500">ログがありません。</td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
