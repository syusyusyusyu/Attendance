<%# AdminKit風QRスキャン: フルスクリーン化、成功アニメーション、位置情報案内 %>
<div class="max-w-none space-y-6 -mx-6 md:-mx-8 lg:-mx-10 px-6 md:px-8 lg:px-10">
  <%# ヘッダー %>
  <div class="page-header">
    <div>
      <h1 class="page-title">QRスキャン</h1>
      <p class="page-subtitle">カメラでQRコードを読み取って出席登録</p>
      <%= breadcrumb(["QRスキャン"]) %>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 items-start">
    <%# メインスキャンエリア %>
    <div class="lg:col-span-2">
      <div class="card min-h-[70vh]">
        <div class="card-body p-0">
          <%= form_with url: scan_path,
            method: :post,
            class: "space-y-0",
            data: {
              controller: "qr-scan",
              action: "submit->qr-scan#prepareSubmit",
              qr_scan_submit_on_scan_value: true,
              qr_scan_location_required_value: true,
              qr_scan_target: "form"
            } do |f| %>

            <%# スキャンフレーム %>
            <div class="relative overflow-hidden mx-auto scan-frame" style="max-width: 100%; border-radius: var(--radius-lg) var(--radius-lg) 0 0; border: 4px solid var(--color-primary);">
              <video
                class="absolute inset-0 w-full h-full bg-gray-900 object-cover"
                data-qr-scan-target="video"
                playsinline
                muted
              ></video>

              <%# スキャンターゲット枠 %>
              <div class="scan-target" aria-hidden="true">
                <span class="scan-corner tl" style="border-color: var(--color-primary);"></span>
                <span class="scan-corner tr" style="border-color: var(--color-primary);"></span>
                <span class="scan-corner bl" style="border-color: var(--color-primary);"></span>
                <span class="scan-corner br" style="border-color: var(--color-primary);"></span>
              </div>

              <%# 成功オーバーレイ %>
              <div class="scan-success" data-qr-scan-target="successOverlay" aria-hidden="true">
                <div class="scan-success-circle"></div>
                <svg class="scan-success-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                  <path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
              </div>

              <%# ステータスメッセージ %>
              <div
                class="absolute bottom-0 left-0 right-0 text-sm text-center text-white py-3 px-4"
                style="background: linear-gradient(transparent, rgba(0,0,0,0.8));"
                data-qr-scan-target="status"
                data-ready-message="カメラを開始してください。"
                data-unsupported-message="この端末ではQRスキャンが使えません。手入力をご利用ください。"
                data-scanning-message="QRコードを枠内に合わせてください。"
                data-detected-message="QRコードを読み取りました。送信中..."
                data-permission-message="カメラの許可が必要です。"
                data-locating-message="位置情報を取得しています..."
                data-location-unsupported-message="位置情報に対応していません。別の端末を利用してください。"
                data-location-denied-message="位置情報が拒否されました。許可して再試行してください。"
                data-location-unavailable-message="位置情報を取得できませんでした。電波の良い場所で再試行してください。"
                data-location-timeout-message="位置情報の取得がタイムアウトしました。再試行してください。"
                data-location-required-message="位置情報が取得できません。位置情報を許可してください。"
                data-error-message="読み取りに失敗しました。手入力をご利用ください。"
              >
                カメラを開始してください。
              </div>
            </div>

            <%# コントロールボタン %>
            <div class="p-4" style="background-color: var(--color-surface-hover);">
              <div class="flex flex-col sm:flex-row items-center justify-center gap-3">
                <button type="button" class="btn btn-primary w-full sm:w-auto" data-action="qr-scan#start">
                  <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z" stroke-linecap="round" stroke-linejoin="round"/>
                    <circle cx="12" cy="13" r="4" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  カメラを開始
                </button>
                <button type="button" class="btn btn-secondary w-full sm:w-auto" data-action="qr-scan#stop">
                  <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="6" y="6" width="12" height="12" rx="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  停止
                </button>
                <button type="button" class="btn btn-secondary w-full sm:w-auto" data-action="qr-scan#toggleManual">
                  <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  手入力
                </button>
              </div>
            </div>

            <%# 手入力フォーム %>
            <div class="p-4 hidden" data-qr-scan-target="manual" style="border-top: 1px solid var(--color-border);">
              <div class="max-w-md mx-auto space-y-4">
                <%= f.label :token, "QRコードの文字列", class: "block text-sm font-medium", style: "color: var(--color-text-primary);" %>
                <%= f.text_area :token, rows: 4, class: "input", required: true, placeholder: "教員から受け取ったQRコード文字列を貼り付けてください", data: { qr_scan_target: "tokenInput" } %>
                <%= f.hidden_field :latitude, data: { qr_scan_target: "latitude" } %>
                <%= f.hidden_field :longitude, data: { qr_scan_target: "longitude" } %>
                <%= f.hidden_field :accuracy, data: { qr_scan_target: "accuracy" } %>
                <%= f.hidden_field :location_source, data: { qr_scan_target: "locationSource" } %>
                <%= f.submit "出席を送信", class: "btn btn-primary w-full" %>
              </div>
            </div>
          <% end %>
        </div>
      </div>

      <%# 位置情報案内 %>
      <div class="card mt-4">
        <div class="card-body">
          <div class="flex items-start gap-3">
            <div class="w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0" style="background-color: var(--color-info-light);">
              <svg class="h-5 w-5" style="color: var(--color-info);" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z" stroke-linecap="round" stroke-linejoin="round"/>
                <circle cx="12" cy="10" r="3" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
            <div>
              <h3 class="font-semibold">位置情報について</h3>
              <p class="text-sm mt-1 text-body-secondary">
                出席登録には位置情報の許可が必要です。大阪情報コンピュータ専門学校の校内（半径50m以内）でのみ有効です。位置情報の精度が150mを超える場合は登録できません。
              </p>
            </div>
          </div>
        </div>
      </div>

      <%# 2回目スキャン説明 %>
      <div class="card mt-4">
        <div class="card-body">
          <div class="flex items-start gap-3">
            <div class="w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0" style="background-color: var(--color-warning-light);">
              <svg class="h-5 w-5" style="color: var(--color-warning);" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <path d="M12 8v4l3 3" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
            <div>
              <h3 class="font-semibold">入室/退室について</h3>
              <p class="text-sm mt-1 text-body-secondary">
                1回目のスキャンで「入室」、2回目のスキャンで「退室」が記録されます。早退判定や滞在時間の計算に使用されます。
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>
