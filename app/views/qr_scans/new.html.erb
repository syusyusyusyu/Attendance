<div class="max-w-2xl mx-auto">
  <div class="card">
    <div class="p-4 bg-google-grey border-b border-gray-200">
      <h2 class="text-xl font-medium text-gray-800">
        QRコードスキャン
      </h2>
    </div>

    <div class="p-6 space-y-6">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2">
          <%= form_with url: scan_path,
            method: :post,
            class: "space-y-6",
            data: {
              controller: "qr-scan",
              action: "submit->qr-scan#prepareSubmit",
              qr_scan_submit_on_scan_value: true,
              qr_scan_location_required_value: true,
              qr_scan_target: "form"
            } do |f| %>
        <div class="relative overflow-hidden rounded-lg mx-auto max-w-sm border-4 border-google-green mb-4 scan-frame">
          <video
            class="absolute inset-0 w-full h-full bg-gray-900 object-cover"
            data-qr-scan-target="video"
            playsinline
            muted
          ></video>
          <div class="absolute top-0 left-0 right-0 bottom-0 border-2 border-google-green border-opacity-50 pointer-events-none"></div>
          <div
            class="absolute bottom-2 left-2 right-2 text-xs text-center text-white bg-black bg-opacity-50 rounded px-2 py-1"
            data-qr-scan-target="status"
            data-ready-message="カメラを開始してください。"
            data-unsupported-message="この端末ではQRスキャンが使えません。手入力をご利用ください。"
            data-scanning-message="QRコードを枠内に合わせてください。"
            data-detected-message="QRコードを読み取りました。送信中..."
            data-permission-message="カメラの許可が必要です。"
            data-locating-message="位置情報を取得しています..."
            data-location-unsupported-message="位置情報に対応していません。別の端末を利用してください。"
            data-location-denied-message="位置情報が拒否されました。許可して再試行してください。"
            data-location-unavailable-message="位置情報を取得できませんでした。電波の良い場所で再試行してください。"
            data-location-timeout-message="位置情報の取得がタイムアウトしました。再試行してください。"
            data-location-required-message="位置情報が取得できません。位置情報を許可してください。"
            data-error-message="読み取りに失敗しました。手入力をご利用ください。"
          >
            カメラを開始してください。
          </div>
        </div>

        <div class="flex flex-col items-center gap-3 sm:flex-row sm:justify-center">
          <button type="button" class="btn btn-primary w-full sm:w-auto" data-action="qr-scan#start">
            カメラを開始
          </button>
          <button type="button" class="btn btn-secondary w-full sm:w-auto" data-action="qr-scan#stop">
            停止
          </button>
          <button type="button" class="btn btn-secondary w-full sm:w-auto" data-action="qr-scan#toggleManual">
            手入力
          </button>
        </div>

        <div class="w-full max-w-md space-y-2 mx-auto hidden" data-qr-scan-target="manual">
          <%= f.label :token, "QRコードの文字列", class: "block text-sm font-medium text-gray-700" %>
          <%= f.text_area :token, rows: 4, class: "input", required: true, data: { qr_scan_target: "tokenInput" } %>
          <%= f.hidden_field :latitude, data: { qr_scan_target: "latitude" } %>
          <%= f.hidden_field :longitude, data: { qr_scan_target: "longitude" } %>
          <%= f.hidden_field :accuracy, data: { qr_scan_target: "accuracy" } %>
          <%= f.hidden_field :location_source, data: { qr_scan_target: "locationSource" } %>
          <%= f.submit "QRコードをスキャン", class: "btn btn-primary w-full" %>
        </div>

        <p class="text-sm text-gray-600 text-center">
          カメラが使えない場合は、手入力ボタンからQRコード文字列を貼り付けてください。
        </p>
        <p class="text-sm text-gray-600 text-center">
          出席登録には位置情報の許可が必要です。
        </p>
          <% end %>
        </div>

        <div class="space-y-4">
          <div class="border border-gray-200 rounded-lg p-4">
            <h3 class="text-sm font-medium text-gray-900 mb-2">スキャン手順</h3>
            <ol class="list-decimal list-inside text-sm text-gray-600 space-y-1">
              <li>「カメラを開始」を押す</li>
              <li>QRを枠内に合わせる</li>
              <li>読み取り後は自動送信</li>
            </ol>
          </div>

          <div class="border border-gray-200 rounded-lg p-4">
            <h3 class="text-sm font-medium text-gray-900 mb-2">よくある原因</h3>
            <ul class="list-disc list-inside text-sm text-gray-600 space-y-1">
              <li>カメラ権限が許可されていない</li>
              <li>QRが古い(更新済み/期限切れ)</li>
              <li>授業が休講または確定済み</li>
              <li>履修登録がない</li>
            </ul>
          </div>

          <div class="border border-gray-200 rounded-lg p-4">
            <h3 class="text-sm font-medium text-gray-900 mb-2">対応ブラウザ</h3>
            <p class="text-sm text-gray-600">
              Chromium系(Chrome/Edge/Brave/Opera/Samsung Internet)推奨。
              iOS Safari 16以降はフォールバック対応です。
            </p>
            <p class="text-xs text-gray-500 mt-2">カメラが使えない場合は手入力をご利用ください。</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
