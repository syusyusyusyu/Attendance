<div class="max-w-2xl mx-auto">
  <div class="card">
    <div class="p-4 bg-google-grey border-b border-gray-200">
      <h2 class="text-xl font-medium text-gray-800 flex items-center">
        <svg class="mr-2 text-google-green" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="6" height="6" />
          <rect x="15" y="3" width="6" height="6" />
          <rect x="3" y="15" width="6" height="6" />
          <path d="M15 15h6v6h-6z" />
          <path d="M11 11h2v2h-2z" />
        </svg>
        QRコードスキャン
      </h2>
    </div>

    <div class="p-6">
      <%= form_with url: scan_path,
        method: :post,
        class: "space-y-6",
        data: { controller: "qr-scan", qr_scan_submit_on_scan_value: true, qr_scan_target: "form" } do |f| %>
        <div class="relative overflow-hidden rounded-lg mx-auto max-w-sm border-4 border-google-green mb-4">
          <video
            class="w-full h-56 bg-gray-900 object-cover"
            data-qr-scan-target="video"
            playsinline
            muted
          ></video>
          <div class="absolute top-0 left-0 right-0 bottom-0 border-2 border-google-green border-opacity-50 pointer-events-none"></div>
          <div
            class="absolute bottom-2 left-2 right-2 text-xs text-center text-white bg-black bg-opacity-50 rounded px-2 py-1"
            data-qr-scan-target="status"
            data-ready-message="カメラを開始してください。"
            data-unsupported-message="この端末ではQRスキャンが使えません。手入力をご利用ください。"
            data-scanning-message="QRコードを枠内に合わせてください。"
            data-detected-message="QRコードを読み取りました。送信中..."
            data-permission-message="カメラの許可が必要です。"
            data-error-message="読み取りに失敗しました。手入力をご利用ください。"
          >
            カメラを開始してください。
          </div>
        </div>

        <div class="flex flex-col items-center gap-3 sm:flex-row sm:justify-center">
          <button type="button" class="btn btn-primary w-full sm:w-auto" data-action="qr-scan#start">
            カメラを開始
          </button>
          <button type="button" class="btn btn-secondary w-full sm:w-auto" data-action="qr-scan#stop">
            停止
          </button>
          <button type="button" class="btn btn-secondary w-full sm:w-auto" data-action="qr-scan#toggleManual">
            手入力
          </button>
        </div>

        <div class="w-full max-w-md space-y-2 mx-auto hidden" data-qr-scan-target="manual">
          <%= f.label :token, "QRコードの文字列", class: "block text-sm font-medium text-gray-700" %>
          <%= f.text_area :token, rows: 4, class: "input", required: true, data: { qr_scan_target: "tokenInput" } %>
          <%= f.submit "QRコードをスキャン", class: "btn btn-primary w-full" %>
        </div>

        <p class="text-sm text-gray-600 text-center">
          カメラが使えない場合は、手入力ボタンからQRコード文字列を貼り付けてください。
        </p>
        <p class="text-xs text-gray-500 text-center">
          対応ブラウザ例: Chrome / Edge / Brave / Opera (Chromium系)、iOS Safari 16以降。
          アプリ内ブラウザや古い端末では手入力になる場合があります。
        </p>
      <% end %>
    </div>
  </div>
</div>
