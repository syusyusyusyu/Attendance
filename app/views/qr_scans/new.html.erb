<%# AdminKit風QRスキャン: フルスクリーン化、成功アニメーション、位置情報案内 %>
<div class="max-w-none space-y-6">
  <%# ヘッダーカード %>
  <div class="card">
    <div class="card-body">
      <div class="flex items-center gap-3">
        <div class="w-12 h-12 rounded-full flex items-center justify-center" style="background-color: var(--color-success-light);">
          <svg class="h-6 w-6" style="color: var(--color-success);" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="6" height="6"/>
            <rect x="15" y="3" width="6" height="6"/>
            <rect x="3" y="15" width="6" height="6"/>
            <path d="M15 15h6v6h-6z"/>
            <path d="M11 11h2v2h-2z"/>
          </svg>
        </div>
        <div>
          <h1 class="text-xl font-bold" style="color: var(--color-text-primary);">QRコードスキャン</h1>
          <p class="text-sm" style="color: var(--color-text-secondary);">カメラでQRコードを読み取って出席登録</p>
        </div>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 items-start">
    <%# メインスキャンエリア %>
    <div class="lg:col-span-2">
      <div class="card min-h-[70vh]">
        <div class="card-body p-0">
          <%= form_with url: scan_path,
            method: :post,
            class: "space-y-0",
            data: {
              controller: "qr-scan",
              action: "submit->qr-scan#prepareSubmit",
              qr_scan_submit_on_scan_value: true,
              qr_scan_location_required_value: true,
              qr_scan_target: "form"
            } do |f| %>

            <%# スキャンフレーム %>
            <div class="relative overflow-hidden mx-auto scan-frame" style="max-width: 100%; border-radius: var(--radius-lg) var(--radius-lg) 0 0; border: 4px solid var(--color-primary);">
              <video
                class="absolute inset-0 w-full h-full bg-gray-900 object-cover"
                data-qr-scan-target="video"
                playsinline
                muted
              ></video>

              <%# スキャンターゲット枠 %>
              <div class="scan-target" aria-hidden="true">
                <span class="scan-corner tl" style="border-color: var(--color-primary);"></span>
                <span class="scan-corner tr" style="border-color: var(--color-primary);"></span>
                <span class="scan-corner bl" style="border-color: var(--color-primary);"></span>
                <span class="scan-corner br" style="border-color: var(--color-primary);"></span>
              </div>

              <%# 成功オーバーレイ %>
              <div class="scan-success" data-qr-scan-target="successOverlay" aria-hidden="true">
                <div class="scan-success-circle"></div>
                <svg class="scan-success-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                  <path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
              </div>

              <%# ステータスメッセージ %>
              <div
                class="absolute bottom-0 left-0 right-0 text-sm text-center text-white py-3 px-4"
                style="background: linear-gradient(transparent, rgba(0,0,0,0.8));"
                data-qr-scan-target="status"
                data-ready-message="カメラを開始してください。"
                data-unsupported-message="この端末ではQRスキャンが使えません。手入力をご利用ください。"
                data-scanning-message="QRコードを枠内に合わせてください。"
                data-detected-message="QRコードを読み取りました。送信中..."
                data-permission-message="カメラの許可が必要です。"
                data-locating-message="位置情報を取得しています..."
                data-location-unsupported-message="位置情報に対応していません。別の端末を利用してください。"
                data-location-denied-message="位置情報が拒否されました。許可して再試行してください。"
                data-location-unavailable-message="位置情報を取得できませんでした。電波の良い場所で再試行してください。"
                data-location-timeout-message="位置情報の取得がタイムアウトしました。再試行してください。"
                data-location-required-message="位置情報が取得できません。位置情報を許可してください。"
                data-error-message="読み取りに失敗しました。手入力をご利用ください。"
              >
                カメラを開始してください。
              </div>
            </div>

            <%# コントロールボタン %>
            <div class="p-4" style="background-color: var(--color-surface-hover);">
              <div class="flex flex-col sm:flex-row items-center justify-center gap-3">
                <button type="button" class="btn btn-primary w-full sm:w-auto" data-action="qr-scan#start">
                  <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z" stroke-linecap="round" stroke-linejoin="round"/>
                    <circle cx="12" cy="13" r="4" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  カメラを開始
                </button>
                <button type="button" class="btn btn-secondary w-full sm:w-auto" data-action="qr-scan#stop">
                  <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="6" y="6" width="12" height="12" rx="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  停止
                </button>
                <button type="button" class="btn btn-secondary w-full sm:w-auto" data-action="qr-scan#toggleManual">
                  <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  手入力
                </button>
              </div>
            </div>

            <%# 手入力フォーム %>
            <div class="p-4 hidden" data-qr-scan-target="manual" style="border-top: 1px solid var(--color-border);">
              <div class="max-w-md mx-auto space-y-4">
                <%= f.label :token, "QRコードの文字列", class: "block text-sm font-medium", style: "color: var(--color-text-primary);" %>
                <%= f.text_area :token, rows: 4, class: "input", required: true, placeholder: "教員から受け取ったQRコード文字列を貼り付けてください", data: { qr_scan_target: "tokenInput" } %>
                <%= f.hidden_field :latitude, data: { qr_scan_target: "latitude" } %>
                <%= f.hidden_field :longitude, data: { qr_scan_target: "longitude" } %>
                <%= f.hidden_field :accuracy, data: { qr_scan_target: "accuracy" } %>
                <%= f.hidden_field :location_source, data: { qr_scan_target: "locationSource" } %>
                <%= f.submit "出席を送信", class: "btn btn-primary w-full" %>
              </div>
            </div>
          <% end %>
        </div>
      </div>

      <%# 位置情報案内 %>
      <div class="card mt-4">
        <div class="card-body">
          <div class="flex items-start gap-3">
            <div class="w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0" style="background-color: var(--color-info-light);">
              <svg class="h-5 w-5" style="color: var(--color-info);" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z" stroke-linecap="round" stroke-linejoin="round"/>
                <circle cx="12" cy="10" r="3" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
            <div>
              <h3 class="font-semibold" style="color: var(--color-text-primary);">位置情報について</h3>
              <p class="text-sm mt-1" style="color: var(--color-text-secondary);">
                出席登録には位置情報の許可が必要です。大阪情報コンピュータ専門学校の校内（半径50m以内）でのみ有効です。位置情報の精度が150mを超える場合は登録できません。
              </p>
            </div>
          </div>
        </div>
      </div>

      <%# 2回目スキャン説明 %>
      <div class="card mt-4">
        <div class="card-body">
          <div class="flex items-start gap-3">
            <div class="w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0" style="background-color: var(--color-warning-light);">
              <svg class="h-5 w-5" style="color: var(--color-warning);" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <path d="M12 8v4l3 3" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
            <div>
              <h3 class="font-semibold" style="color: var(--color-text-primary);">入室/退室について</h3>
              <p class="text-sm mt-1" style="color: var(--color-text-secondary);">
                1回目のスキャンで「入室」、2回目のスキャンで「退室」が記録されます。早退判定や滞在時間の計算に使用されます。
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <%# サイドパネル %>
    <div class="space-y-4">
      <%# スキャン手順 %>
      <div class="card">
        <div class="card-header">
          <h3 class="font-semibold" style="color: var(--color-text-primary);">スキャン手順</h3>
        </div>
        <div class="card-body">
          <ol class="space-y-3">
            <li class="flex items-start gap-3">
              <span class="w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold text-white flex-shrink-0" style="background-color: var(--color-primary);">1</span>
              <span class="text-sm" style="color: var(--color-text-primary);">「カメラを開始」を押す</span>
            </li>
            <li class="flex items-start gap-3">
              <span class="w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold text-white flex-shrink-0" style="background-color: var(--color-primary);">2</span>
              <span class="text-sm" style="color: var(--color-text-primary);">QRを枠内に合わせる</span>
            </li>
            <li class="flex items-start gap-3">
              <span class="w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold text-white flex-shrink-0" style="background-color: var(--color-primary);">3</span>
              <span class="text-sm" style="color: var(--color-text-primary);">読み取り後は自動送信</span>
            </li>
          </ol>
        </div>
      </div>

      <%# トラブルシューティング %>
      <div class="card">
        <div class="card-header">
          <h3 class="font-semibold" style="color: var(--color-text-primary);">トラブル時の確認</h3>
        </div>
        <div class="card-body">
          <ul class="space-y-2 text-sm" style="color: var(--color-text-secondary);">
            <li class="flex items-start gap-2">
              <svg class="h-4 w-4 mt-0.5 flex-shrink-0" style="color: var(--color-text-muted);" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <path d="M12 16v-4M12 8h.01"/>
              </svg>
              <span>QRが古い/期限切れの場合は再発行を確認</span>
            </li>
            <li class="flex items-start gap-2">
              <svg class="h-4 w-4 mt-0.5 flex-shrink-0" style="color: var(--color-text-muted);" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <path d="M12 16v-4M12 8h.01"/>
              </svg>
              <span>休講・確定済みの授業はスキャン不可</span>
            </li>
            <li class="flex items-start gap-2">
              <svg class="h-4 w-4 mt-0.5 flex-shrink-0" style="color: var(--color-text-muted);" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <path d="M12 16v-4M12 8h.01"/>
              </svg>
              <span>履修登録がない場合は教員へ連絡</span>
            </li>
            <li class="flex items-start gap-2">
              <svg class="h-4 w-4 mt-0.5 flex-shrink-0" style="color: var(--color-text-muted);" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <path d="M12 16v-4M12 8h.01"/>
              </svg>
              <span>推奨: Chrome/Edge (iOSはSafari 16+)</span>
            </li>
            <li class="flex items-start gap-2">
              <svg class="h-4 w-4 mt-0.5 flex-shrink-0" style="color: var(--color-text-muted);" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <path d="M12 16v-4M12 8h.01"/>
              </svg>
              <span>カメラ不可時は手入力を利用</span>
            </li>
          </ul>
        </div>
      </div>

      <%# エラー時の対処 %>
      <div class="card" style="border-color: var(--color-error-light);">
        <div class="card-header" style="background-color: var(--color-error-light);">
          <h3 class="font-semibold" style="color: var(--color-error-dark);">エラーが出る場合</h3>
        </div>
        <div class="card-body">
          <ul class="space-y-2 text-sm" style="color: var(--color-text-secondary);">
            <li><strong>トークン期限切れ:</strong> QRコードは5分で期限切れ。教員に再発行を依頼</li>
            <li><strong>位置情報エラー:</strong> ブラウザ設定で位置情報を許可し、電波の良い場所で再試行</li>
            <li><strong>精度エラー:</strong> 屋外や窓際など、GPS受信が良い場所へ移動</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>
