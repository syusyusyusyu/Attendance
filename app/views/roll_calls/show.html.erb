<div class="max-w-4xl mx-auto space-y-6">
  <%# ページヘッダー %>
  <div class="page-header">
    <div>
      <h1 class="page-title">点呼モード</h1>
      <p class="page-subtitle">対面で学生を確認しながら出席登録</p>
      <%= breadcrumb(["点呼モード"]) %>
    </div>
  </div>

  <%# クラス・日付選択 %>
  <div class="card">
    <div class="card-header">
      <h2 class="font-semibold">クラス・日付選択</h2>
    </div>
    <div class="card-body">
      <%= form_with url: roll_call_path, method: :get, class: "space-y-4" do |f| %>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <%= f.label :class_id, "クラス", class: "block text-sm font-medium mb-2", style: "color: var(--color-text-primary);" %>
            <%= f.select :class_id,
              options_for_select(@classes.map { |klass| ["#{klass.name} (#{klass.room})", klass.id] }, @selected_class&.id),
              { include_blank: "クラスを選択" },
              class: "input" %>
          </div>
          <div>
            <%= f.label :date, "日付", class: "block text-sm font-medium mb-2", style: "color: var(--color-text-primary);" %>
            <%= f.date_field :date, value: @date, class: "input" %>
          </div>
        </div>
        <%= f.submit "表示", class: "btn btn-primary" %>
      <% end %>
    </div>
  </div>

  <% if @selected_class && @students %>
    <%# 進捗バー %>
    <div class="card">
      <div class="card-body">
        <div class="flex items-center justify-between mb-2">
          <span class="text-sm font-medium">確認済み</span>
          <span class="text-sm font-semibold" data-roll-call-target="counter">
            <%= @confirmed %> / <%= @total %> 人
          </span>
        </div>
        <div class="w-full rounded-full h-3" style="background: var(--color-bg-hover);">
          <div
            class="rounded-full h-3 transition-all duration-300"
            style="width: <%= @total > 0 ? (@confirmed * 100.0 / @total).round : 0 %>%; background: var(--color-success);"
            data-roll-call-target="progressBar"
          ></div>
        </div>
      </div>
    </div>

    <%# 学生リスト %>
    <%= form_with url: roll_call_path, method: :patch, data: { controller: "roll-call" } do |f| %>
      <%= f.hidden_field :class_id, value: @selected_class.id %>
      <%= f.hidden_field :date, value: @date %>

      <div class="space-y-2">
        <% @students.each do |student| %>
          <% record = @records[student.id] %>
          <% qr_confirmed = record&.verification_method_qrcode? && record&.status_present? %>
          <% roll_call_confirmed = record&.verification_method_roll_call? && record&.status_present? %>
          <% already_present = record&.status_present? || record&.status_late? %>

          <div class="card">
            <div class="card-body py-3">
              <div class="flex items-center justify-between gap-4">
                <div class="flex items-center gap-3 min-w-0">
                  <div class="w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0" style="background: var(--color-bg-hover);">
                    <span class="text-sm font-semibold"><%= student.name.first(1) %></span>
                  </div>
                  <div class="min-w-0">
                    <div class="font-medium truncate"><%= student.name %></div>
                    <div class="text-xs text-body-muted"><%= student.student_id %></div>
                  </div>
                </div>

                <div class="flex items-center gap-2 flex-shrink-0">
                  <% if qr_confirmed %>
                    <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium" style="background: var(--color-success-light, rgba(16,185,129,0.1)); color: var(--color-success);">
                      <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                      QR確認済み
                    </span>
                  <% elsif already_present %>
                    <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium" style="background: var(--color-info-light, rgba(59,130,246,0.1)); color: var(--color-info);">
                      <%= record&.status_label || "出席" %>
                    </span>
                  <% else %>
                    <label class="relative inline-flex items-center cursor-pointer">
                      <input
                        type="checkbox"
                        name="student_ids[]"
                        value="<%= student.id %>"
                        <%= "checked" if roll_call_confirmed %>
                        class="sr-only peer"
                        data-action="change->roll-call#toggle"
                      />
                      <div class="w-14 h-8 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-1 after:left-1 after:rounded-full after:h-6 after:w-6 after:transition-all" style="background: var(--color-bg-hover);" data-checked-style="background: var(--color-success);"></div>
                    </label>
                  <% end %>
                </div>
              </div>
            </div>
          </div>
        <% end %>
      </div>

      <div class="mt-6">
        <%= f.submit "点呼を完了", class: "btn btn-primary w-full text-lg py-3" %>
      </div>
    <% end %>
  <% end %>
</div>
