# 解説.md ～ 仕様書をやさしく理解するガイド ～

**情報系専門学生向けの技術解説ドキュメント**

> 仕様書.mdの各セクションを、プログラミング初学者〜中級者向けにかみ砕いて解説しています。

このドキュメントでは、仕様書に登場する専門用語・設計パターン・図の読み方を丁寧に説明します。  
就職活動やポートフォリオ作成の際に「なぜこう設計したか」を説明できるようになることを目指します。

<br>

---

## 目次

| セクション | 内容 |
|:---|:---|
| **基礎知識** | 用語集 / MVCパターン / Web開発の基本 |
| **概要の読み方** | 1分説明のコツ / 展示ポイントの意味 |
| **プロダクトの理解** | ユーザーロール / 出席ポリシーの設計意図 |
| **技術の理解** | Rails 8 / Hotwire / セキュリティ設計 |
| **設計図の読み方** | Mermaid図 / ER図 / クラス図 |
| **品質・運用の意味** | テスト設計 / デプロイ / 環境変数 |

<br>

---
---

# PART 1: 基礎知識

---

## 用語集（50音順）

| 用語 | 読み方 | 意味 |
|:---|:---|:---|
| API | エーピーアイ | アプリ同士がデータをやり取りする仕組み |
| bcrypt | ビークリプト | パスワードを安全にハッシュ化するアルゴリズム |
| Controller | コントローラー | リクエストを受け取り、処理を振り分ける役割 |
| ER図 | イーアールず | テーブル同士の関係を図にしたもの |
| FK | エフケー | Foreign Key（外部キー）の略、他テーブルを参照 |
| Hotwire | ホットワイヤー | Rails標準のリアルタイム更新技術 |
| IPO図 | アイピーオーず | Input/Process/Outputの流れを示す図 |
| JSONB | ジェイソンビー | PostgreSQLのJSON型、検索も可能 |
| Mermaid | マーメイド | マークダウンで図を描くツール |
| Model | モデル | データベースとやり取りする役割 |
| MVC | エムブイシー | Model/View/Controllerの設計パターン |
| ORM | オーアールエム | SQLを書かずにDBを操作する仕組み |
| PK | ピーケー | Primary Key（主キー）の略、一意の識別子 |
| PostgreSQL | ポストグレスキューエル | 高機能なリレーショナルデータベース |
| PWA | ピーダブリューエー | アプリのように動くWebサイト |
| Service | サービス | ビジネスロジックを分離したクラス |
| Stimulus | スティミュラス | 軽量なJavaScriptフレームワーク |
| Tailwind | テイルウィンド | クラス名でスタイルを当てるCSSフレームワーク |
| Turbo | ターボ | 画面遷移なしで部分更新する技術 |
| UK | ユーケー | Unique Key（一意キー）の略 |
| View | ビュー | 画面（HTML）を生成する役割 |
| ジオフェンス | - | 位置情報で「囲い」を作る技術 |
| トークン | - | 認証や署名に使う一時的な文字列 |
| ハッシュ化 | - | 元に戻せない形でデータを変換すること |
| レート制限 | - | 短時間の連続アクセスを制限すること |
| ロールバック | - | 処理を途中でキャンセルして元に戻すこと |

<br>

---

## MVCパターンとは？

Webアプリケーションの基本的な設計パターンです。  
役割を分けることで、コードが整理され、修正しやすくなります。

```
┌─────────────────────────────────────────────────┐
│                   ブラウザ                       │
│                (ユーザーの画面)                   │
└─────────────────┬───────────────────────────────┘
                  │ リクエスト（URLにアクセス）
                  ▼
┌─────────────────────────────────────────────────┐
│              Controller（交通整理係）             │
│    「/scan にアクセスが来た！スキャン処理しよう」   │
└───────┬─────────────────────────────┬───────────┘
        │ データ取得を依頼            │ 結果を表示
        ▼                            ▼
┌───────────────────┐      ┌───────────────────┐
│  Model（倉庫係）   │      │   View（表示係）   │
│  DBからデータ取得  │      │  HTMLを組み立て    │
└───────────────────┘      └───────────────────┘
```

### このシステムでの具体例

| 役割 | ファイル例 | やっていること |
|:---|:---|:---|
| Controller | `qr_scans_controller.rb` | QRスキャン画面の表示、入力を受け取る |
| Model | `attendance_record.rb` | 出席データの保存・検索・バリデーション |
| View | `qr_scans/new.html.erb` | スキャン画面のHTML |

<br>

---

## Service Objectとは？

MVCだけだと、Controllerが太りすぎて読みにくくなります。  
「ビジネスロジック」を別のクラスに分離したのがService Objectです。

```
┌─────────────────────────────────────────────────┐
│   Controller（薄く保つ）                         │
│   「入力を受け取って、Serviceに丸投げ」           │
└───────────────────┬─────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────┐
│   Service（複雑な処理を担当）                    │
│   「トークン検証→位置確認→出席登録→ログ記録」   │
└───────────────────┬─────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────┐
│   Model（データの読み書きのみ）                  │
└─────────────────────────────────────────────────┘
```

### このシステムでの具体例

| Service | 役割 |
|:---|:---|
| `AttendanceToken` | QRトークンの生成・検証 |
| `QrScanProcessor` | スキャン処理の全体統括 |
| `AttendanceFinalizer` | 締切後の自動欠席確定 |

<br>

---
---

# PART 2: 概要の読み方

---

## 「1分でわかる」の意味

就職面接やプレゼンで「このシステムは何ですか？」と聞かれたとき、  
**最初の1分**で相手の興味を引けるかが勝負です。

仕様書の「1分でわかる」セクションは、この順番で説明します：

```
1. 体験 → 「何ができるか」をユーザー視点で
2. 特徴 → 「他と何が違うか」を技術視点で
3. 強み → 「なぜ優れているか」を設計視点で
4. 価値 → 「誰にどんなメリットがあるか」
```

### 例：このシステムの1分説明

> 「QRコードをスキャンするだけで出席登録ができるシステムです。  
> 位置情報認証で代返を防止し、承認ワークフローと監査ログで  
> 実運用にも耐える設計になっています。」

<br>

---

## 展示ポイントの設計意図

展示会では、来場者は短時間で多くのブースを見て回ります。  
**3つのポイントに絞る**ことで、印象に残りやすくなります。

| ポイント | なぜ選んだか |
|:---|:---|
| 校内でしか出席できない | 他の出席システムとの差別化、技術的なチャレンジ |
| リアルタイム反映 | 見た目でわかりやすい、デモ映えする |
| 3ロール運用 | 実務で使える設計力をアピール |

<br>

---
---

# PART 3: プロダクトの理解

---

## ユーザーロールとは？

「誰が何をできるか」を明確に分けることで、  
**権限の漏れ**（学生が出席を改ざんできる等）を防ぎます。

```
┌─────────────────────────────────────────────────┐
│                  管理者（Admin）                 │
│          ┌─────────────────────┐               │
│          │    教員（Teacher）    │               │
│          │   ┌─────────────┐   │               │
│          │   │ 学生（Student）│   │               │
│          │   └─────────────┘   │               │
│          └─────────────────────┘               │
└─────────────────────────────────────────────────┘

※ 上位ロールは下位ロールの機能を含む
```

### 権限設計のポイント

| 原則 | 説明 | このシステムでの例 |
|:---|:---|:---|
| 最小権限 | 必要最低限の権限だけ与える | 学生は自分の出席だけ見える |
| 職務分離 | 重要操作は複数人で | 出席確定は管理者承認が必要 |
| 監査証跡 | 誰が何をしたか記録 | 変更ログをすべて保存 |

<br>

---

## 出席ポリシーの設計意図

「ルールをハードコーディング（コードに直書き）しない」ことが重要です。

```ruby
# ❌ 悪い例：コードに直書き
if Time.now > class_start + 20.minutes
  status = :late
end

# ✅ 良い例：設定から読み込む
if Time.now > class_start + policy.late_after_minutes.minutes
  status = :late
end
```

### なぜ設定にするのか？

| 理由 | 説明 |
|:---|:---|
| 学校ごとに違う | A校は15分、B校は30分で遅刻かもしれない |
| 変更しやすい | コードを変えずに設定だけ変更できる |
| テストしやすい | テスト時は短い時間でテストできる |

<br>

---
---

# PART 4: 技術の理解

---

## Rails 8 + Hotwireとは？

従来のWebアプリは「リンクをクリック→画面全体が再読み込み」でした。  
Hotwireは「必要な部分だけ更新」できる技術です。

```
従来のWebアプリ:
[ボタンクリック] → [サーバーに送信] → [画面全体を再描画] → [チラつく]

Hotwire:
[ボタンクリック] → [サーバーに送信] → [変更部分だけ差し替え] → [スムーズ]
```

### Turbo Frame / Turbo Stream の違い

| 技術 | 用途 | このシステムでの例 |
|:---|:---|:---|
| Turbo Frame | 画面の一部を枠で囲んで差し替え | 出席一覧のフィルタ |
| Turbo Stream | サーバーから「この部分を更新しろ」と指示 | 出席登録後の即時反映 |

<br>

---

## セキュリティ設計の考え方

「どんな攻撃があるか」を想定して、それぞれに対策します。

### 想定される攻撃と対策

| 攻撃 | 内容 | このシステムの対策 |
|:---|:---|:---|
| 代返 | 友達のQRを撮影して別の場所でスキャン | 位置情報認証（ジオフェンス） |
| QR偽造 | 自分でQRを作成 | 署名付きトークン（改ざん検知） |
| 連打攻撃 | 大量リクエストでシステムダウン | レート制限（分あたり回数制限） |
| トークン共有 | 1つのQRを複数人で使い回し | 不正検知（同一トークンの複数人利用を検知） |
| パスワード総当たり | 全パターンを試す | bcryptハッシュ（計算に時間がかかる） |

### 署名付きトークンの仕組み

```
1. サーバーが「クラスID + 日付 + 秘密鍵」をハッシュ化 → トークン生成
2. 学生がトークンを送信
3. サーバーが同じ計算をして、一致するか確認
4. 一致しない = 改ざんされている → 拒否
```

<br>

---

## 位置情報認証（ジオフェンス）の仕組み

「学校の中心から半径50m以内か」を計算で判定します。

```
                  半径50m
            ┌───────────────┐
            │               │
            │   ⭐ 学校     │
            │               │
            │    📱 学生A   │ → OK（中にいる）
            └───────────────┘
                        📱 学生B → NG（外にいる）
```

### 距離の計算（ハーバーサイン公式）

地球は丸いので、単純な引き算では距離が出せません。  
緯度・経度から「球面上の距離」を計算します。

```ruby
# 簡略化した例
def distance_km(lat1, lng1, lat2, lng2)
  # 地球の半径: 6371km
  # 三角関数を使って球面上の距離を計算
  # ...
end

if distance_km(school_lat, school_lng, student_lat, student_lng) <= 0.05
  "校内です"
else
  "校外です"
end
```

<br>

---
---

# PART 5: 設計図の読み方

---

## Mermaid図とは？

マークダウンで図を描けるツールです。  
GitHubやQiitaでそのまま表示されます。

```markdown
# 書き方
flowchart LR
  A[箱A] --> B[箱B]
  B --> C[箱C]
```

```mermaid
flowchart LR
  A[箱A] --> B[箱B]
  B --> C[箱C]
```

### よく使う記法

| 記法 | 意味 | 使い方 |
|:---|:---|:---|
| `flowchart TB` | 上から下へ流れる図 | 処理フロー |
| `flowchart LR` | 左から右へ流れる図 | データの流れ |
| `graph TD` | 階層構造 | 機能一覧 |
| `erDiagram` | ER図 | DB設計 |
| `classDiagram` | クラス図 | コード設計 |
| `stateDiagram` | 状態遷移図 | 画面遷移 |
| `mindmap` | マインドマップ | 要件整理 |

<br>

---

## ER図の読み方

ER図は「テーブル同士の関係」を表します。

```mermaid
erDiagram
  USERS ||--o{ ATTENDANCE_RECORDS : "1人が複数の出席を持つ"
```

### 記号の意味

| 記号 | 読み方 | 意味 |
|:---|:---|:---|
| `\|\|` | 1 | 必ず1つ |
| `o{` | 0以上 | 0個でも複数でもOK |
| `\|{` | 1以上 | 最低1つは必要 |

### このシステムのER図を読む

```
USERS ||--o{ ATTENDANCE_RECORDS : records
↑       ↑
1人     0個以上

= 「1人のユーザーは、0個以上の出席記録を持つ」
```

<br>

---

## クラス図の読み方

クラス図は「クラス同士の関係」を表します。

```mermaid
classDiagram
  class User {
    +email
    +name
    +authenticate()
  }
  class AttendanceRecord {
    +date
    +status
  }
  User "1" --o "*" AttendanceRecord : has
```

### 記号の意味

| 記号 | 意味 |
|:---|:---|
| `+` | public（外から見える） |
| `-` | private（外から見えない） |
| `#` | protected（継承先から見える） |
| `--o` | 集約（持っている） |
| `-->` | 依存（使っている） |
| `<\|--` | 継承（親子関係） |

<br>

---

## IPO図の読み方

IPO図は「入力→処理→出力」を明確にします。

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   Input     │ →  │   Process   │ →  │   Output    │
│  （入力）    │    │  （処理）    │    │  （出力）    │
└─────────────┘    └─────────────┘    └─────────────┘
```

### このシステムでの例：QRスキャン

| Input | Process | Output |
|:---|:---|:---|
| トークン、位置情報 | トークン検証→位置検証→出席登録 | 成功/失敗メッセージ |

<br>

---

## 画面遷移図の読み方

「どの画面からどの画面に行けるか」を表します。

```mermaid
stateDiagram-v2
  [*] --> ログイン
  ログイン --> ダッシュボード: 成功
  ログイン --> ログイン: 失敗
  ダッシュボード --> QRスキャン
```

### 記号の意味

| 記号 | 意味 |
|:---|:---|
| `[*]` | 開始点 |
| `-->` | 遷移 |
| `: ラベル` | 遷移条件 |

<br>

---
---

# PART 6: 品質・運用の意味

---

## テスト設計の考え方

「動くかどうか」だけでなく「壊れないか」を確認します。

### テストの種類

| 種類 | 範囲 | このシステムでの例 |
|:---|:---|:---|
| 単体テスト | 1つのメソッド | `AttendancePolicy#late?` |
| 結合テスト | 複数のクラス | ログイン→ダッシュボード表示 |
| システムテスト | ブラウザ操作 | QRスキャンの一連の流れ |

### 境界値テスト

「境界」で不具合が起きやすいので、重点的にテストします。

```
遅刻判定: 20分

テストケース:
- 19分59秒 → 出席（OK）
- 20分00秒 → 出席（OK）← 境界
- 20分01秒 → 遅刻（NG）← 境界
```

<br>

---

## 環境変数とは？

「コードに書いてはいけない情報」を外部から渡す仕組みです。

```ruby
# ❌ 悪い例：コードに直書き
DATABASE_URL = "postgres://user:password@localhost/db"

# ✅ 良い例：環境変数から読み込む
DATABASE_URL = ENV["DATABASE_URL"]
```

### なぜ環境変数を使うのか？

| 理由 | 説明 |
|:---|:---|
| セキュリティ | パスワードがGitHubに公開されない |
| 環境ごとの切り替え | 開発用と本番用でDBを変えられる |
| チーム開発 | 各自のローカル設定を共有しなくていい |

<br>

---

## デプロイとは？

「開発環境」から「本番環境」にコードを配置することです。

```
開発環境（自分のPC）
     │
     │ git push
     ▼
GitHub（コード保管庫）
     │
     │ 自動デプロイ
     ▼
本番環境（Render）
     │
     │ アクセス
     ▼
ユーザーのブラウザ
```

### このシステムのデプロイ先

| サービス | 役割 | 無料枠 |
|:---|:---|:---|
| Render | Webサーバー | あり（スリープあり） |
| Render PostgreSQL | データベース | あり（90日制限） |

<br>

---
---

# PART 7: 就活・ポートフォリオへの活用

---

## 面接で聞かれそうな質問と回答例

### Q1. このシステムの特徴は？

> 「QRコードと位置情報認証を組み合わせた出席管理システムです。  
> 署名付きトークンで改ざんを防止し、ジオフェンスで代返を防いでいます。」

### Q2. なぜこの技術を選んだ？

> 「Rails 8とHotwireを選んだ理由は、リアルタイム更新が必要だったからです。  
> SPAフレームワークより学習コストが低く、少人数で開発できます。」

### Q3. 苦労した点は？

> 「位置情報の精度問題です。GPSは±10m程度の誤差があるため、  
> 精度が低い場合は警告を出し、150m以上の誤差は拒否する設計にしました。」

### Q4. 改善したい点は？

> 「現在は単一校舎を想定していますが、複数キャンパス対応や  
> Bluetooth Beaconによる屋内測位を追加したいです。」

<br>

---

## ポートフォリオに書くべきポイント

| 項目 | 書くこと |
|:---|:---|
| 概要 | 1〜2文でシステムの目的 |
| 技術スタック | 使用した言語・フレームワーク・DB |
| 担当範囲 | 自分が実装した機能 |
| 工夫した点 | 技術的なチャレンジ |
| 学んだこと | 開発を通じて得た知識 |
| デモURL | 動いているサイトのURL |
| GitHubリポジトリ | ソースコードのURL |

<br>

---

## 参考リンク

| トピック | URL |
|:---|:---|
| Ruby on Rails ガイド | https://railsguides.jp/ |
| Hotwire 公式 | https://hotwired.dev/ |
| Tailwind CSS | https://tailwindcss.com/ |
| Mermaid | https://mermaid.js.org/ |
| PostgreSQL | https://www.postgresql.jp/ |
